<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Calendar - ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏™‡∏∏‡∏î‡∏Ñ‡∏π‡∏•</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --primary: #6c5ce7;
            --secondary: #a29bfe;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        body {
            font-family: 'Prompt', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: #2d3436;
        }

        /* Glassmorphism Card */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            padding: 20px;
            margin-top: 20px;
        }

        /* Customizing FullCalendar */
        .fc-toolbar-title { font-size: 1.5rem !important; font-weight: 600; color: var(--primary); }
        .fc-button-primary { background-color: var(--primary) !important; border: none !important; }
        .fc-button-primary:hover { background-color: #5849c4 !important; }
        .fc-daygrid-day.fc-day-today { background-color: rgba(162, 155, 254, 0.2) !important; }
        .fc-event { cursor: pointer; border: none !important; padding: 2px 5px; }
        
        /* Event Colors */
        .event-work { background-color: #ff7675; }
        .event-personal { background-color: #00cec9; }
        .event-school { background-color: #fdcb6e; color: black; }

        .auth-box { max-width: 400px; margin: 10vh auto; }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark bg-transparent">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#"><i class="far fa-calendar-check"></i> Life Planner</a>
            <div id="user-controls" class="d-none">
                <span id="user-email" class="text-white me-2"></span>
                <button onclick="logout()" class="btn btn-sm btn-outline-light rounded-pill">Logout</button>
            </div>
        </div>
    </nav>

    <div id="auth-section" class="container">
        <div class="glass-card auth-box text-center">
            <h3 class="fw-bold mb-4 text-primary">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</h3>
            <div class="form-floating mb-3">
                <input type="email" class="form-control" id="email" placeholder="name@example.com">
                <label>Email</label>
            </div>
            <div class="form-floating mb-3">
                <input type="password" class="form-control" id="password" placeholder="Password">
                <label>Password</label>
            </div>
            <button onclick="login()" class="btn btn-primary w-100 py-2 rounded-pill fw-bold">Login / Register</button>
            <small class="d-block mt-3 text-muted">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà</small>
        </div>
    </div>

    <div id="app-section" class="container-fluid px-4 d-none">
        <div class="row">
            <div class="col-lg-3 mb-4">
                <div class="glass-card h-100">
                    <h5 class="fw-bold mb-3"><i class="fas fa-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h5>
                    
                    <div class="mb-3">
                        <label class="small text-muted">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà...</label>
                        <div class="input-group">
                            <input type="date" id="search-date" class="form-control">
                            <button class="btn btn-primary" onclick="searchByDate()"><i class="fas fa-arrow-right"></i></button>
                        </div>
                    </div>
                    
                    <button class="btn btn-outline-primary w-100 mb-2" onclick="checkToday()">
                        ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á?
                    </button>
                    <button class="btn btn-outline-secondary w-100 mb-4" onclick="checkTomorrow()">
                        ‡πÅ‡∏•‡πâ‡∏ß‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏•‡πà‡∏∞?
                    </button>

                    <hr>
                    <h6 class="fw-bold mt-4">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏µ</h6>
                    <ul class="list-unstyled">
                        <li><span class="badge bg-danger">‚óè</span> ‡∏á‡∏≤‡∏ô‡∏î‡πà‡∏ß‡∏ô/‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</li>
                        <li><span class="badge bg-info text-dark">‚óè</span> ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß/‡∏ä‡∏¥‡∏•‡πÜ</li>
                        <li><span class="badge bg-warning text-dark">‚óè</span> ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</li>
                    </ul>
                </div>
            </div>

            <div class="col-lg-9 mb-4">
                <div class="glass-card">
                    <div id="calendar"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDT39HkTA1TLFKvuQNZcrNeIZMLANgy2z0",
            authDomain: "scan-4b703.firebaseapp.com",
            projectId: "scan-4b703",
            storageBucket: "scan-4b703.firebasestorage.app",
            messagingSenderId: "667992011250",
            appId: "1:667992011250:web:adce534c0f97b4ddb47b6b",
            measurementId: "G-X5QG9YZWG6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let calendar;
        let currentUser = null;
        let unsubscribe = null;

        // --- Auth Logic ---
        window.login = async () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            try {
                await signInWithEmailAndPassword(auth, e, p);
            } catch (err) {
                try {
                    await createUserWithEmailAndPassword(auth, e, p);
                    Swal.fire("‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö", "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success");
                } catch (err2) { Swal.fire("Error", err2.message, "error"); }
            }
        };

        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                document.getElementById('auth-section').classList.add('d-none');
                document.getElementById('app-section').classList.remove('d-none');
                document.getElementById('user-controls').classList.remove('d-none');
                document.getElementById('user-email').innerText = user.email;
                initCalendar();
            } else {
                document.getElementById('auth-section').classList.remove('d-none');
                document.getElementById('app-section').classList.add('d-none');
                document.getElementById('user-controls').classList.add('d-none');
            }
        });

        // --- Calendar Logic ---
        function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'th', // ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,listMonth'
                },
                height: 'auto',
                events: async (info, successCallback, failureCallback) => {
                    // Load Events from Firebase Realtime
                    if(unsubscribe) unsubscribe();
                    
                    const q = query(collection(db, "calendar_events"), where("userId", "==", currentUser.uid));
                    unsubscribe = onSnapshot(q, (snapshot) => {
                        const events = snapshot.docs.map(doc => {
                            const d = doc.data();
                            return {
                                id: doc.id,
                                title: d.title,
                                start: d.date,
                                backgroundColor: d.color,
                                borderColor: d.color,
                                extendedProps: { details: d.details }
                            };
                        });
                        successCallback(events);
                    });
                },
                dateClick: handleDateClick,
                eventClick: handleEventClick
            });
            calendar.render();
        }

        // 1. Add Event
        async function handleDateClick(info) {
            const { value: formValues } = await Swal.fire({
                title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà',
                html: `
                    <input id="swal-title" class="swal2-input" placeholder="‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏î‡∏µ? (‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô, ‡πÑ‡∏õ‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß)">
                    <select id="swal-type" class="swal2-select" style="display:flex; margin:10px auto; width:80%">
                        <option value="#ff7675">üî• ‡∏á‡∏≤‡∏ô‡∏î‡πà‡∏ß‡∏ô</option>
                        <option value="#00cec9">üèñÔ∏è ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß/‡∏ä‡∏¥‡∏•‡πÜ</option>
                        <option value="#fdcb6e">üéì ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
                    </select>
                    <div style="margin-top:10px">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${info.dateStr}</div>
                `,
                focusConfirm: false,
                preConfirm: () => {
                    return [
                        document.getElementById('swal-title').value,
                        document.getElementById('swal-type').value
                    ]
                }
            });

            if (formValues && formValues[0]) {
                try {
                    await addDoc(collection(db, "calendar_events"), {
                        userId: currentUser.uid,
                        title: formValues[0],
                        color: formValues[1],
                        date: info.dateStr,
                        createdAt: new Date()
                    });
                    // Calendar will auto update via onSnapshot
                    Swal.fire('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß!', '', 'success');
                } catch(e) { console.error(e); }
            }
        }

        // 2. Delete Event
        async function handleEventClick(info) {
            const result = await Swal.fire({
                title: info.event.title,
                text: "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: " + info.event.start.toLocaleDateString('th-TH'),
                icon: 'info',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: '‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ',
                cancelButtonText: '‡∏õ‡∏¥‡∏î'
            });

            if (result.isConfirmed) {
                await deleteDoc(doc(db, "calendar_events", info.event.id));
                info.event.remove();
                Swal.fire('‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', '', 'success');
            }
        }

        // 3. Search Functions
        window.searchByDate = async () => {
            const dateInput = document.getElementById('search-date').value;
            if(!dateInput) return;
            
            showEventsForDate(dateInput, "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å");
        };

        window.checkToday = () => {
            const today = new Date().toISOString().split('T')[0];
            showEventsForDate(today, "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á?");
        };

        window.checkTomorrow = () => {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const dateStr = tomorrow.toISOString().split('T')[0];
            showEventsForDate(dateStr, "‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á?");
        };

        async function showEventsForDate(dateStr, title) {
            // Query specific date
            const q = query(
                collection(db, "calendar_events"), 
                where("userId", "==", currentUser.uid),
                where("date", "==", dateStr)
            );
            
            const snapshot = await getDocs(q);
            let html = '';
            
            if(snapshot.empty) {
                html = '<p class="text-muted">-- ‡∏ß‡πà‡∏≤‡∏á‡∏à‡πâ‡∏≤ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô --</p>';
            } else {
                html = '<ul class="list-group text-start">';
                snapshot.forEach(doc => {
                    const d = doc.data();
                    html += `<li class="list-group-item" style="border-left: 5px solid ${d.color}">
                        ${d.title}
                    </li>`;
                });
                html += '</ul>';
            }

            Swal.fire({
                title: title,
                html: html,
                footer: `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateStr}`
            });
            
            // Jump calendar to that date
            calendar.gotoDate(dateStr);
        }

    </script>
</body>
</html>
