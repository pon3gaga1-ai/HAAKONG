<!DOCTYPE html>
<html lang="th" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PayLink Admin Pro</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&family=Prompt:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lazywasabi/thai-bank-icons@master/dist/css/thai-bank-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --bg-main: #0f172a;
            --card-glass: rgba(30, 41, 59, 0.7);
            --primary: #818cf8;
            --success: #34d399;
            --danger: #f87171;
        }

        body {
            font-family: 'Prompt', sans-serif;
            background-color: var(--bg-main);
            background-image: radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%), 
                              radial-gradient(at 100% 100%, rgba(16, 185, 129, 0.1) 0px, transparent 50%);
            background-attachment: fixed;
            color: #f1f5f9;
            min-height: 100vh;
        }

        /* Glassmorphism */
        .glass-card {
            background: var(--card-glass);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
            transition: transform 0.2s ease;
        }
        
        /* Client Card */
        .client-card {
            position: relative;
            overflow: hidden;
        }
        .client-card:hover { transform: translateY(-5px); border-color: rgba(255,255,255,0.2); }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .bg-active { background-color: var(--success); box-shadow: 0 0 10px var(--success); }
        .bg-expired { background-color: var(--danger); }

        /* Bank Grid Selector (ตัวเลือกธนาคารแบบใหม่) */
        .bank-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding: 5px;
        }
        .bank-option {
            cursor: pointer;
            border-radius: 12px;
            background: rgba(0,0,0,0.3);
            border: 2px solid transparent;
            text-align: center;
            padding: 10px 5px;
            transition: all 0.2s;
        }
        .bank-option:hover { background: rgba(255,255,255,0.1); }
        .bank-option input { display: none; }
        .bank-option.selected {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.2);
            transform: scale(0.95);
        }
        .bank-option i { font-size: 24px; margin-bottom: 5px; display: block; }
        .bank-option span { font-size: 10px; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Bank Card Display */
        .bank-display-card {
            display: flex; align-items: center; justify-content: space-between;
            padding: 16px; border-radius: 16px; margin-bottom: 12px;
            background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(0,0,0,0.2));
            border: 1px solid rgba(255,255,255,0.05);
        }
        
        /* Floating Login */
        .admin-trigger {
            position: fixed; bottom: 30px; right: 30px;
            width: 55px; height: 55px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.2);
            color: rgba(255,255,255,0.5);
            display: flex; align-items: center; justify-content: center;
            transition: 0.3s; z-index: 1000;
        }
        .admin-trigger:hover { background: var(--primary); color: white; opacity: 1; transform: scale(1.1); }

    </style>
</head>
<body>

    <div class="container py-5">
        
        <div id="client-view" class="d-none fade-in">
            <div class="text-center mb-5">
                <div class="d-inline-block p-3 rounded-circle bg-white bg-opacity-10 mb-3 shadow-lg">
                    <i class="fas fa-wallet fa-2x text-white"></i>
                </div>
                <h2 id="client-name-display" class="fw-bold mb-1">...</h2>
                <span class="badge bg-secondary bg-opacity-50 rounded-pill px-3 fw-light">Payment Method</span>
                
                <div id="client-status-alert" class="alert alert-danger mt-4 d-none">
                    <i class="fas fa-lock me-2"></i> บัญชีนี้หมดอายุ กรุณาติดต่อแอดมิน
                </div>
            </div>

            <div id="public-bank-list" class="mx-auto" style="max-width: 500px;"></div>

            <div class="text-center mt-5 pt-4 border-top border-secondary border-opacity-25 mx-auto" style="max-width: 400px;">
                <p class="text-secondary small">ติดปัญหาหรือต้องการต่ออายุ?</p>
                <a id="admin-fb-link" href="#" target="_blank" class="btn btn-primary rounded-pill px-4 shadow-lg btn-sm">
                    <i class="fab fa-facebook-messenger me-2"></i> ติดต่อแอดมิน
                </a>
            </div>
        </div>


        <div id="admin-dashboard" class="d-none">
            
            <div class="d-flex justify-content-between align-items-center mb-5">
                <div>
                    <h3 class="fw-bold m-0 text-white"><span class="text-primary">Pay</span>Link <span class="fs-6 fw-light text-muted">Admin</span></h3>
                    <small class="text-muted"><i class="fas fa-circle text-success" style="font-size: 8px;"></i> Online: <span id="admin-display-email"></span></small>
                </div>
                <button onclick="logout()" class="btn btn-outline-danger btn-sm rounded-pill px-3">Log out</button>
            </div>

            <div class="row g-4 mb-4">
                <div class="col-md-4">
                    <div class="glass-card h-100 d-flex flex-column justify-content-center">
                        <label class="small text-muted mb-2"><i class="fab fa-facebook me-1"></i> ลิงก์ติดต่อ (FB)</label>
                        <div class="input-group input-group-sm">
                            <input type="text" id="config-fb" class="form-control bg-dark text-white border-secondary" placeholder="https://m.me/...">
                            <button class="btn btn-primary" onclick="saveConfig()"><i class="fas fa-save"></i></button>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="glass-card h-100">
                        <h5 class="fw-bold mb-3 text-white"><i class="fas fa-plus-circle text-primary me-2"></i>เพิ่มลูกค้าใหม่</h5>
                        <div class="row g-2">
                            <div class="col-md-4"><input id="new-name" class="form-control bg-dark text-white border-secondary" placeholder="ชื่อลูกค้า"></div>
                            <div class="col-md-3"><input id="new-code" class="form-control bg-dark text-white border-secondary" placeholder="ตั้งรหัสลับ"></div>
                            <div class="col-md-3"><input type="number" id="new-days" class="form-control bg-dark text-white border-secondary" placeholder="วันใช้งาน (30)"></div>
                            <div class="col-md-2"><button onclick="createClient()" class="btn btn-success w-100 h-100"><i class="fas fa-magic"></i></button></div>
                        </div>
                    </div>
                </div>
            </div>

            <h5 class="text-white mb-3 ps-2 border-start border-4 border-primary">รายชื่อลูกค้า</h5>
            <div id="client-list-admin" class="row g-3"></div>
        </div>

    </div>

    <div class="modal fade" id="bankModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content glass-card bg-dark text-white border-0">
                <div class="modal-header border-bottom border-secondary border-opacity-25">
                    <div>
                        <h5 class="modal-title fw-bold">จัดการบัญชี</h5>
                        <small class="text-muted" id="modal-client-name">...</small>
                    </div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    
                    <label class="small text-muted mb-2">เลือกธนาคาร:</label>
                    <div class="bank-grid mb-3" id="bank-selector-grid">
                        </div>
                    <input type="hidden" id="selected-bank-val">

                    <div class="input-group mb-4">
                        <span class="input-group-text bg-dark border-secondary text-secondary"><i class="fas fa-hashtag"></i></span>
                        <input id="add-acc-num" class="form-control bg-dark text-white border-secondary" placeholder="เลขบัญชี / เบอร์โทร">
                        <button onclick="addBankToClient()" class="btn btn-primary px-4">เพิ่ม</button>
                    </div>

                    <div class="d-flex align-items-center mb-2">
                        <hr class="flex-grow-1 border-secondary border-opacity-25">
                        <span class="px-2 small text-muted">รายการที่มีอยู่</span>
                        <hr class="flex-grow-1 border-secondary border-opacity-25">
                    </div>
                    
                    <div id="modal-bank-list" style="max-height: 250px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <button onclick="openLogin()" class="admin-trigger shadow"><i class="fas fa-shield-alt"></i></button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, deleteDoc, updateDoc, doc, setDoc, onSnapshot, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDT39HkTA1TLFKvuQNZcrNeIZMLANgy2z0",
            authDomain: "scan-4b703.firebaseapp.com",
            projectId: "scan-4b703",
            storageBucket: "scan-4b703.firebasestorage.app",
            messagingSenderId: "667992011250",
            appId: "1:667992011250:web:adce534c0f97b4ddb47b6b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // --- ADMIN EMAIL ---
        const ADMIN_EMAIL = "fafa@gmail.com"; 

        // --- BANK DATA (รวมธนาคารไทยเยอะๆ) ---
        const BANKS = [
            { code: 'kbank', name: 'กสิกรไทย', icon: 'pf-kbank', color: '#00cc6a' },
            { code: 'scb', name: 'ไทยพาณิชย์', icon: 'pf-scb', color: '#4e2e7f' },
            { code: 'ktb', name: 'กรุงไทย', icon: 'pf-krungthai', color: '#00a5e5' },
            { code: 'bbl', name: 'กรุงเทพ', icon: 'pf-bbl', color: '#1e4598' },
            { code: 'gsb', name: 'ออมสิน', icon: 'pf-gsb', color: '#eb198d' },
            { code: 'ttb', name: 'ทีทีบี', icon: 'pf-ttb', color: '#0050f0' },
            { code: 'bay', name: 'กรุงศรี', icon: 'pf-krungsri', color: '#fec43b' },
            { code: 'uob', name: 'UOB', icon: 'pf-uob', color: '#0b3979' },
            { code: 'baac', name: 'ธ.ก.ส.', icon: 'pf-baac', color: '#4b9b1d' },
            { code: 'cimb', name: 'CIMB', icon: 'pf-cimb', color: '#7e2f36' },
            { code: 'lh', name: 'LH Bank', icon: 'pf-lh', color: '#6d6e71' },
            { code: 'truemoney', name: 'TrueMoney', icon: 'pf-wallet', color: '#ff5c00' },
            { code: 'promptpay', name: 'พร้อมเพย์', icon: 'pf-promptpay', color: '#1c3d6e' }
        ];

        let currentAdmin = null;
        let editingClientId = null;

        // --- INIT ---
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            loadGlobalConfig();
            
            // Render Bank Grid in Modal
            renderBankSelector();

            if(code) loadClientView(code);
        };

        function renderBankSelector() {
            const grid = document.getElementById('bank-selector-grid');
            grid.innerHTML = '';
            BANKS.forEach(b => {
                grid.innerHTML += `
                    <div class="bank-option" onclick="selectBank('${b.code}', this)">
                        <i class="pf ${b.icon}" style="color: ${b.color}"></i>
                        <span>${b.name}</span>
                    </div>`;
            });
        }
        
        window.selectBank = (code, el) => {
            document.querySelectorAll('.bank-option').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('selected-bank-val').value = code;
        }

        async function loadGlobalConfig() {
            try {
                const d = await getDoc(doc(db, "system_config", "main"));
                if (d.exists()) {
                    const link = d.data().fbLink || "#";
                    document.getElementById('admin-fb-link').href = link;
                    document.getElementById('config-fb').value = link;
                }
            } catch(e){}
        }

        // --- AUTH & ADMIN ---
        onAuthStateChanged(auth, (user) => {
            if (user && user.email === ADMIN_EMAIL) {
                currentAdmin = user;
                document.getElementById('admin-dashboard').classList.remove('d-none');
                document.getElementById('client-view').classList.add('d-none');
                document.getElementById('admin-display-email').innerText = user.email;
                loadAllClients();
            } else {
                currentAdmin = null;
                document.getElementById('admin-dashboard').classList.add('d-none');
            }
        });

        window.openLogin = async () => {
            if(currentAdmin) return;
            const { value: v } = await Swal.fire({
                title: 'Admin Login',
                html: '<input id="sw-email" class="swal2-input" placeholder="Email"><input id="sw-pass" type="password" class="swal2-input" placeholder="Password">',
                focusConfirm: false,
                background: '#1e293b', color: '#fff',
                preConfirm: () => [document.getElementById('sw-email').value, document.getElementById('sw-pass').value]
            });
            if (v) {
                if(v[0] !== ADMIN_EMAIL) return Swal.fire('Error', 'Unauthorized Email', 'error');
                try { await signInWithEmailAndPassword(auth, v[0], v[1]); } 
                catch (e) { Swal.fire('Failed', e.message, 'error'); }
            }
        };
        window.logout = () => signOut(auth);

        // --- CLIENT MANAGEMENT ---
        window.createClient = async () => {
            const name = document.getElementById('new-name').value;
            const code = document.getElementById('new-code').value.toUpperCase();
            const days = parseInt(document.getElementById('new-days').value) || 30;
            if(!name || !code) return Swal.fire('ข้อมูลไม่ครบ','','warning');

            const expireAt = new Date(); expireAt.setDate(expireAt.getDate() + days);
            
            try {
                const snap = await getDocs(query(collection(db, "clients"), where("code", "==", code)));
                if(!snap.empty) return Swal.fire('รหัสซ้ำ', '', 'error');
                
                await addDoc(collection(db, "clients"), { name, code, expireAt: expireAt.getTime(), createdAt: Date.now() });
                Swal.fire('สำเร็จ', '', 'success');
                document.getElementById('new-name').value=''; document.getElementById('new-code').value='';
            } catch(e) { Swal.fire('Error', e.message, 'error'); }
        };

        function loadAllClients() {
            onSnapshot(query(collection(db, "clients"), orderBy("createdAt", "desc")), (snap) => {
                const list = document.getElementById('client-list-admin'); list.innerHTML = '';
                snap.forEach(d => {
                    const data = d.data();
                    const timeLeft = Math.ceil((data.expireAt - Date.now()) / (86400000));
                    const isExp = timeLeft <= 0;
                    
                    list.innerHTML += `
                    <div class="col-md-6 col-lg-4">
                        <div class="glass-card client-card p-3 h-100 d-flex flex-column">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="fw-bold m-0 text-white">${data.name}</h5>
                                <span class="badge ${isExp ? 'bg-danger' : 'bg-success'} bg-opacity-75 rounded-pill">${isExp ? 'หมดอายุ' : timeLeft + ' วัน'}</span>
                            </div>
                            <div class="text-muted small mb-1">Code: <span class="text-info font-monospace">${data.code}</span></div>
                            <div class="text-muted small mb-auto">Link: <u class="text-white-50 cursor-pointer" onclick="copy('${window.location.origin}?code=${data.code}')">Copy Link</u></div>
                            
                            <div class="mt-3 pt-3 border-top border-secondary border-opacity-25 d-flex gap-2">
                                <button onclick="openBankModal('${d.id}', '${data.name}')" class="btn btn-sm btn-primary flex-grow-1"><i class="fas fa-wallet"></i> บัญชี</button>
                                <button onclick="extendTime('${d.id}')" class="btn btn-sm btn-dark border-secondary"><i class="fas fa-history"></i></button>
                                <button onclick="deleteClient('${d.id}')" class="btn btn-sm btn-dark border-secondary text-danger"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>`;
                });
            });
        }

        window.openBankModal = (id, name) => {
            editingClientId = id;
            document.getElementById('modal-client-name').innerText = name;
            loadClientBanks(id, 'modal-bank-list', true);
            new bootstrap.Modal(document.getElementById('bankModal')).show();
        };

        // --- BANK LOGIC ---
        window.addBankToClient = async () => {
            const bankCode = document.getElementById('selected-bank-val').value;
            const num = document.getElementById('add-acc-num').value;
            if(!bankCode) return Swal.fire('กรุณาเลือกธนาคาร','','warning');
            if(!num) return Swal.fire('กรุณาใส่เลขบัญชี','','warning');

            await addDoc(collection(db, "bank_accounts"), { clientId: editingClientId, bank: bankCode, accNum: num, createdAt: Date.now() });
            document.getElementById('add-acc-num').value = '';
        };

        window.deleteBank = async (id) => await deleteDoc(doc(db, "bank_accounts", id));

        // --- PUBLIC VIEW LOGIC ---
        async function loadClientView(code) {
            const snap = await getDocs(query(collection(db, "clients"), where("code", "==", code.toUpperCase())));
            if(snap.empty) return Swal.fire({icon: 'error', title: 'ไม่พบข้อมูล'});
            
            const client = snap.docs[0].data();
            if(Date.now() > client.expireAt) {
                document.getElementById('client-status-alert').classList.remove('d-none');
            } else {
                loadClientBanks(snap.docs[0].id, 'public-bank-list', false);
            }
            document.getElementById('client-name-display').innerText = client.name;
            document.getElementById('client-view').classList.remove('d-none');
        }

        function loadClientBanks(clientId, elId, isAdmin) {
            onSnapshot(query(collection(db, "bank_accounts"), where("clientId", "==", clientId)), (snap) => {
                const el = document.getElementById(elId); el.innerHTML = '';
                if(snap.empty && !isAdmin) el.innerHTML = '<div class="text-center text-muted py-4">ยังไม่เพิ่มบัญชี</div>';
                
                snap.forEach(d => {
                    const b = d.data();
                    const info = BANKS.find(x => x.code === b.bank) || BANKS[0];
                    
                    const controls = isAdmin 
                        ? `<button onclick="deleteBank('${d.id}')" class="btn btn-sm btn-dark text-danger border-0 rounded-circle ms-2"><i class="fas fa-times"></i></button>`
                        : `<button onclick="copy('${b.accNum}')" class="btn btn-sm btn-light rounded-pill px-3 fw-bold small">Copy</button>`;

                    el.innerHTML += `
                    <div class="bank-display-card">
                        <div class="d-flex align-items-center">
                            <div class="rounded-3 d-flex align-items-center justify-content-center me-3 shadow-sm" style="width:48px; height:48px; background:white;">
                                <i class="pf ${info.icon}" style="font-size:28px; color:${info.color};"></i>
                            </div>
                            <div>
                                <div class="small opacity-75" style="color:${info.color}">${info.name}</div>
                                <div class="fs-5 fw-bold font-monospace text-white">${formatAcc(b.accNum)}</div>
                            </div>
                        </div>
                        <div>${controls}</div>
                    </div>`;
                });
            });
        }

        // --- UTILS ---
        window.saveConfig = async () => {
            await setDoc(doc(db, "system_config", "main"), { fbLink: document.getElementById('config-fb').value });
            Swal.fire('Saved', '', 'success');
        }
        window.extendTime = async (id) => {
            const { value } = await Swal.fire({title:'เพิ่มวัน', input:'number', inputValue:30, background:'#1e293b', color:'#fff'});
            if(value) {
                const d = new Date(); d.setDate(d.getDate() + parseInt(value));
                await updateDoc(doc(db, "clients", id), { expireAt: d.getTime() });
            }
        }
        window.deleteClient = async (id) => { if((await Swal.fire({title:'ลบ?',icon:'warning',showCancelButton:true})).isConfirmed) deleteDoc(doc(db,"clients",id)); }
        
        const formatAcc = (n) => n.length >= 10 ? n.replace(/(\d{3})(\d{1,})(\d{4})/, "$1-$2-$3") : n;
        window.copy = (t) => { navigator.clipboard.writeText(t); Swal.fire({toast:true,position:'top',icon:'success',title:'Copied',showConfirmButton:false,timer:800, background: '#333', color:'#fff'}); }

    </script>
</body>
</html>
