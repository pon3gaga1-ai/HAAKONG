<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Item Tracker - ‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÉ‡∏´‡∏°‡πà</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #6c5ce7;
            --secondary-color: #a29bfe;
            --bg-color: #f8f9fd;
            --card-hover-transform: translateY(-5px);
        }

        body {
            font-family: 'Prompt', sans-serif;
            background-color: var(--bg-color);
            color: #2d3436;
        }

        .navbar { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); }
        .btn-primary { background-color: var(--primary-color); border: none; }
        .btn-primary:hover { background-color: #5849c4; }
        .text-primary-custom { color: var(--primary-color); }

        /* Card Animations & Styling */
        .item-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            background: white;
            overflow: hidden;
            border-left: 4px solid transparent;
        }

        .item-card:hover {
            transform: var(--card-hover-transform);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }
        
        .zone-badge {
            background: #ffeaa7;
            color: #d63031;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            display: inline-block;
        }

        .location-detail {
            color: #636e72;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        /* Smooth entry animation */
        .fade-in-up { animation: fadeInUp 0.5s ease both; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translate3d(0, 20px, 0); }
            to { opacity: 1; transform: none; }
        }

        .auth-card { max-width: 400px; margin: 60px auto; padding: 40px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand navbar-dark shadow-sm mb-4">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#"><i class="fas fa-box-open"></i> My Stuff Tracker</a>
            <div class="d-flex align-items-center" id="nav-controls">
                </div>
        </div>
    </nav>

    <div id="auth-section" class="container">
        <div class="auth-card bg-white text-center">
            <h3 class="mb-4 fw-bold text-primary-custom">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</h3>
            <div class="form-floating mb-3">
                <input type="email" class="form-control" id="email" placeholder="name@example.com">
                <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
            </div>
            <div class="form-floating mb-3">
                <input type="password" class="form-control" id="password" placeholder="Password">
                <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
            </div>
            <div class="d-grid gap-2">
                <button onclick="login()" class="btn btn-primary btn-lg fw-bold">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                <button onclick="register()" class="btn btn-outline-secondary">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
            </div>
        </div>
    </div>

    <div id="app-section" class="container d-none">
        
        <div class="row mb-4 g-3">
            <div class="col-md-4">
                <div class="card shadow-sm border-0 h-100 p-3 bg-white">
                    <label class="form-label fw-bold"><i class="fas fa-key text-warning"></i> ‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á/‡∏ö‡πâ‡∏≤‡∏ô</label>
                    <div class="input-group">
                        <input type="text" id="active-code" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô home1 (‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô)">
                        <button class="btn btn-primary" onclick="loadData()">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-8">
                 <div class="card shadow-sm border-0 h-100 p-3 bg-white d-flex justify-content-center">
                    <div class="input-group input-group-lg">
                        <span class="input-group-text bg-transparent border-0 ps-0"><i class="fas fa-search text-muted"></i></span>
                        <input type="text" id="search-box" class="form-control border-0 shadow-none ps-1 bg-transparent" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤... ‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏∏‡∏ç‡πÅ‡∏à, ‡πÉ‡∏ô‡∏•‡∏¥‡πâ‡∏ô‡∏ä‡∏±‡∏Å, ‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô" disabled>
                    </div>
                 </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-md-4 col-lg-3">
                <div class="d-grid gap-2 mb-3">
                     <button class="btn btn-primary shadow-sm py-2 fw-bold" onclick="openAddItemModal()" id="btn-add-item" disabled>
                        <i class="fas fa-plus-circle"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
                    </button>
                </div>

                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white fw-bold py-3">
                        <i class="fas fa-map-signs text-primary-custom"></i> ‡πÇ‡∏ã‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ
                    </div>
                    <div class="card-body p-2 bg-white">
                        <ul class="list-group list-group-flush" id="zone-list-display">
                           <li class="text-muted text-center py-2 small">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÇ‡∏ã‡∏ô</li>
                        </ul>
                        <div class="input-group mt-3">
                            <input type="text" id="new-zone-name" class="form-control form-control-sm" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏ã‡∏ô‡πÉ‡∏´‡∏°‡πà.." disabled>
                            <button class="btn btn-sm btn-outline-primary" onclick="addNewZone()" id="btn-add-zone" disabled><i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-8 col-lg-9">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold m-0"><i class="fas fa-boxes"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (<span id="item-count">0</span>)</h5>
                </div>
                
                <div id="item-list-container" class="row g-3">
                    <div class="col-12 text-center text-muted py-5">
                        <i class="fas fa-box-open fa-3x mb-3 text-secondary opacity-25"></i>
                        <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡πÇ‡∏´‡∏•‡∏î</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addItemModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">üì¶ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body pt-4">
                    <div class="mb-3">
                        <label class="form-label fw-bold">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡πà‡∏á‡∏Ç‡∏≠‡∏á</label>
                        <input type="text" id="item-name" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏û‡∏≤‡∏™‡∏õ‡∏≠‡∏£‡πå‡∏ï, ‡∏£‡∏µ‡πÇ‡∏°‡∏ó‡πÅ‡∏≠‡∏£‡πå">
                    </div>
                    
                    <div class="mb-3">
                         <label class="form-label fw-bold"><i class="fas fa-map-marker-alt text-danger"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô</label>
                        <select id="item-zone-select" class="form-select">
                            <option value="" selected disabled>-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô --</option>
                            </select>
                        <div class="form-text small text-end"><a href="#" onclick="document.querySelector('.btn-close').click(); document.getElementById('new-zone-name').focus();">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏ã‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ö‡∏ã‡πâ‡∏≤‡∏¢‡∏°‡∏∑‡∏≠</a></div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á (‡∏ä‡∏±‡∏î‡πÜ)</label>
                        <textarea id="item-location-detail" class="form-control" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏•‡∏¥‡πâ‡∏ô‡∏ä‡∏±‡∏Å‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏ï‡∏π‡πâ‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤, ‡∏ö‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏π‡πâ‡πÄ‡∏¢‡πá‡∏ô"></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="button" onclick="saveItem()" class="btn btn-primary px-4 fw-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, deleteDoc, doc, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDT39HkTA1TLFKvuQNZcrNeIZMLANgy2z0",
            authDomain: "scan-4b703.firebaseapp.com",
            projectId: "scan-4b703",
            storageBucket: "scan-4b703.firebasestorage.app",
            messagingSenderId: "667992011250",
            appId: "1:667992011250:web:adce534c0f97b4ddb47b6b",
            measurementId: "G-X5QG9YZWG6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let allItems = [];
        let currentZones = [];
        let fuse;
        const addItemModal = new bootstrap.Modal(document.getElementById('addItemModal'));
        let itemUnsubscribe = null;
        let zoneUnsubscribe = null;

        // --- Auth ---
        window.login = async () => {
            try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); } 
            catch (e) { alert(e.message); }
        };
        window.register = async () => {
            try { await createUserWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); alert("‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); } catch (e) { alert(e.message); }
        };
        window.logout = () => {
            if(itemUnsubscribe) itemUnsubscribe();
            if(zoneUnsubscribe) zoneUnsubscribe();
            signOut(auth);
        }

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                document.getElementById('auth-section').classList.add('d-none');
                document.getElementById('app-section').classList.remove('d-none');
                document.getElementById('nav-controls').innerHTML = `<span class="text-white me-3"><i class="fas fa-user-circle"></i> ${user.email.split('@')[0]}</span><button onclick="logout()" class="btn btn-sm btn-light text-primary fw-bold">Logout</button>`;
            } else {
                document.getElementById('auth-section').classList.remove('d-none');
                document.getElementById('app-section').classList.add('d-none');
                resetUI();
            }
        });

        function resetUI() {
             document.getElementById('item-list-container').innerHTML = '<div class="col-12 text-center text-muted py-5"><i class="fas fa-box-open fa-3x mb-3 text-secondary opacity-25"></i><p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</p></div>';
             document.getElementById('zone-list-display').innerHTML = '';
             toggleControls(false);
        }

        function toggleControls(enable) {
            document.getElementById('search-box').disabled = !enable;
            document.getElementById('btn-add-item').disabled = !enable;
            document.getElementById('new-zone-name').disabled = !enable;
            document.getElementById('btn-add-zone').disabled = !enable;
        }


        // --- Main Logic ---
        window.loadData = () => {
            const code = document.getElementById('active-code').value.trim();
            if (!code) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á");
            
            if(itemUnsubscribe) itemUnsubscribe();
            if(zoneUnsubscribe) zoneUnsubscribe();

            toggleControls(true);

            // 1. Load Zones (Realtime)
            const zoneQ = query(collection(db, "zones"), where("secretCode", "==", code), orderBy("name"));
            zoneUnsubscribe = onSnapshot(zoneQ, (snapshot) => {
                currentZones = [];
                const zoneListDisplay = document.getElementById('zone-list-display');
                const zoneSelect = document.getElementById('item-zone-select');
                
                zoneListDisplay.innerHTML = '';
                zoneSelect.innerHTML = '<option value="" selected disabled>-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô --</option>';

                if(snapshot.empty) {
                    zoneListDisplay.innerHTML = '<li class="list-group-item text-muted small text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏ã‡∏ô ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏¢!</li>';
                }

                snapshot.forEach(doc => {
                    const zone = doc.data();
                    currentZones.push(zone.name);
                    // Update sidebar list
                    zoneListDisplay.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center"><span class="badge bg-light text-dark border"><i class="fas fa-map-marker-alt text-danger"></i> ${zone.name}</span></li>`;
                    // Update modal select dropdown
                    zoneSelect.innerHTML += `<option value="${zone.name}">${zone.name}</option>`;
                });
            });


            // 2. Load Items (Realtime)
            const itemQ = query(collection(db, "items"), where("secretCode", "==", code), orderBy("timestamp", "desc"));
            itemUnsubscribe = onSnapshot(itemQ, (snapshot) => {
                allItems = [];
                snapshot.forEach(doc => allItems.push({ id: doc.id, ...doc.data() }));
                
                document.getElementById('item-count').innerText = allItems.length;

                // Config Fuzzy Search including new fields
                fuse = new Fuse(allItems, { includeScore: true, keys: ['name', 'zone', 'locationDetails'], threshold: 0.3 });
                
                renderItems(allItems);
            });
        };

        function renderItems(items) {
            const container = document.getElementById('item-list-container');
            container.innerHTML = '';

            if (items.length === 0) {
                 container.innerHTML = '<div class="col-12 text-center text-muted py-5"><i class="fas fa-ghost fa-3x mb-3 text-secondary opacity-25"></i><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ</p></div>';
                 return;
            }

            items.forEach((item, index) => {
                // Assign a color border based on zone (simple hashing)
                const colors = ['primary', 'success', 'danger', 'warning', 'info'];
                const zoneColor = colors[item.zone.length % colors.length];

                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-4 fade-in-up';
                col.style.animationDelay = `${index * 0.05}s`;

                col.innerHTML = `
                    <div class="card item-card h-100 border-${zoneColor}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title fw-bold mb-0 text-dark">${item.name}</h5>
                                ${currentUser.uid === item.userId ? `<button class="btn btn-sm btn-link text-danger p-0" onclick="deleteItem('${item.id}')"><i class="fas fa-trash-alt"></i></button>` : ''}
                            </div>
                            <div class="mb-3">
                                <span class="zone-badge"><i class="fas fa-map-marker-alt"></i> ‡πÇ‡∏ã‡∏ô: ${item.zone}</span>
                            </div>
                             <div class="location-detail bg-light p-2 rounded">
                                <i class="fas fa-info-circle text-${zoneColor}"></i> <b>‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á:</b> ${item.locationDetails || '-'}
                            </div>
                             <div class="text-end mt-2">
                                <small class="text-muted" style="font-size: 0.75rem;"><i class="far fa-clock"></i> ${item.timestamp?.toDate().toLocaleDateString('th-TH')}</small>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(col);
            });
        }

        // --- Actions ---
        window.addNewZone = async () => {
            const nameInput = document.getElementById('new-zone-name');
            const name = nameInput.value.trim();
            const code = document.getElementById('active-code').value;
            if(!name || !code) return;

            if(currentZones.includes(name)) return alert("‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏ã‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß");

            try {
                await addDoc(collection(db, "zones"), { name, secretCode: code, userId: currentUser.uid });
                nameInput.value = '';
            } catch(e) { console.error(e); }
        };

        window.openAddItemModal = () => {
             if(currentZones.length === 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏° '‡πÇ‡∏ã‡∏ô' ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö (‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ö‡∏ã‡πâ‡∏≤‡∏¢‡∏°‡∏∑‡∏≠)");
             document.getElementById('item-name').value = '';
             document.getElementById('item-location-detail').value = '';
             document.getElementById('item-zone-select').selectedIndex = 0;
             addItemModal.show();
        }

        window.saveItem = async () => {
            const name = document.getElementById('item-name').value.trim();
            const zone = document.getElementById('item-zone-select').value;
            const locationDetails = document.getElementById('item-location-detail').value.trim();
            const code = document.getElementById('active-code').value;

            if(!name || !zone) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô");

            try {
                await addDoc(collection(db, "items"), {
                    userId: currentUser.uid, secretCode: code,
                    name, zone, locationDetails,
                    timestamp: new Date()
                });
                addItemModal.hide();
            } catch (e) { console.error(e); }
        };

        window.deleteItem = async (id) => {
            if(confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")) await deleteDoc(doc(db, "items", id));
        };

        // --- Search ---
        document.getElementById('search-box').addEventListener('keyup', (e) => {
            const term = e.target.value;
            if (!term) {
                renderItems(allItems);
                return;
            }
            const results = fuse.search(term).map(r => r.item);
            renderItems(results);
        });
    </script>
</body>
</html>
