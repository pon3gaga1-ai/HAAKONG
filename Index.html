<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Item Tracker - ‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap');
        
        body { font-family: 'Sarabun', sans-serif; background-color: #f4f7f6; }
        
        /* Map Styles */
        .map-wrapper {
            position: relative;
            width: 100%;
            padding-bottom: 66%; /* Aspect Ratio 3:2 */
            background-color: #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 3px solid #fff;
            cursor: crosshair;
            transition: all 0.3s;
        }

        .map-image {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover;
            /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ */
            background-image: url('https://images.unsplash.com/photo-1580587771525-78b9dba3b91d?auto=format&fit=crop&w=1000&q=80');
            background-size: cover;
            background-position: center;
        }

        /* Marker Styles */
        .marker {
            position: absolute;
            transform: translate(-50%, -100%); /* ‡∏õ‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≤‡∏¢‡πÅ‡∏´‡∏•‡∏° */
            font-size: 24px;
            color: #dc3545;
            text-shadow: 0 2px 5px rgba(0,0,0,0.4);
            cursor: pointer;
            transition: transform 0.2s;
            z-index: 10;
        }
        .marker:hover { transform: translate(-50%, -120%) scale(1.2); color: #ffc107; }
        
        .marker-label {
            position: absolute;
            top: -30px; left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: #fff;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }
        .marker:hover .marker-label { opacity: 1; }

        /* Search Highlight */
        .marker.dimmed { opacity: 0.2; }
        .marker.highlighted { z-index: 20; animation: bounce 1s infinite; }

        @keyframes bounce {
            0%, 100% { transform: translate(-50%, -100%); }
            50% { transform: translate(-50%, -130%); }
        }

        /* Login Card */
        .auth-card { max-width: 400px; margin: 50px auto; padding: 30px; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        .zone-badge { position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.9); padding: 5px 15px; border-radius: 20px; font-weight: bold; color: #333; z-index: 5; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="fas fa-search-location"></i> Smart Tracker</a>
            <div class="d-flex" id="nav-controls">
                </div>
        </div>
    </nav>

    <div id="auth-section" class="container">
        <div class="auth-card text-center">
            <h3 class="mb-4">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
            <div class="form-floating mb-3">
                <input type="email" class="form-control" id="email" placeholder="name@example.com">
                <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
            </div>
            <div class="form-floating mb-3">
                <input type="password" class="form-control" id="password" placeholder="Password">
                <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
            </div>
            <button onclick="login()" class="btn btn-primary w-100 mb-2">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            <button onclick="register()" class="btn btn-outline-secondary w-100">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà</button>
        </div>
    </div>

    <div id="app-section" class="container py-4 d-none">
        
        <div class="row mb-4 g-3 align-items-center">
            <div class="col-md-4">
                <div class="input-group">
                    <span class="input-group-text bg-white"><i class="fas fa-key text-warning"></i></span>
                    <input type="text" id="active-code" class="form-control" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á (‡πÄ‡∏ä‡πà‡∏ô home1)" onchange="loadItems()">
                    <button class="btn btn-outline-primary" onclick="loadItems()">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
                <small class="text-muted ms-2">*‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á</small>
            </div>

            <div class="col-md-8">
                <div class="input-group shadow-sm">
                    <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-primary"></i></span>
                    <input type="text" id="search-box" class="form-control border-start-0" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á... (‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏õ‡∏£‡∏á‡∏ü‡∏±‡∏ô, ‡∏Å‡∏∏‡∏ç‡πÅ‡∏à)">
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8 mb-4">
                <div class="card shadow border-0">
                    <div class="card-body p-2">
                        <div class="map-wrapper" id="map-container">
                            <div class="map-image"></div>
                            <div class="zone-badge"><i class="fas fa-home"></i> ‡πÅ‡∏ú‡∏ô‡∏ú‡∏±‡∏á‡∏´‡∏•‡∏±‡∏Å</div>
                            </div>
                    </div>
                </div>
                <div class="text-center mt-2 text-muted">
                    <small><i class="fas fa-mouse-pointer"></i> ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡∏†‡∏≤‡∏û‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡∏¥‡πà‡∏á‡∏Ç‡∏≠‡∏á</small>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card shadow border-0 h-100">
                    <div class="card-header bg-white font-weight-bold">
                        <i class="fas fa-list"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ
                    </div>
                    <div class="card-body p-0" style="max-height: 500px; overflow-y: auto;">
                        <ul class="list-group list-group-flush" id="item-list">
                            </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addItemModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="new-x"><input type="hidden" id="new-y">
                    
                    <div class="mb-3">
                        <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡πà‡∏á‡∏Ç‡∏≠‡∏á</label>
                        <input type="text" id="item-name" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏£‡∏ñ, ‡∏£‡∏µ‡πÇ‡∏°‡∏ó">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                        <select id="item-category" class="form-select">
                            <option value="‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ">üì¶ ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
                            <option value="‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£">üìÑ ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</option>
                            <option value="‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå">üíª ‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå</option>
                            <option value="‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß">ü™• ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</option>
                            <option value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠">üîß ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ä‡πà‡∏≤‡∏á</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="button" onclick="saveItem()" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDT39HkTA1TLFKvuQNZcrNeIZMLANgy2z0",
            authDomain: "scan-4b703.firebaseapp.com",
            projectId: "scan-4b703",
            storageBucket: "scan-4b703.firebasestorage.app",
            messagingSenderId: "667992011250",
            appId: "1:667992011250:web:adce534c0f97b4ddb47b6b",
            measurementId: "G-X5QG9YZWG6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let allItems = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡∏ó‡∏≥ Search ‡∏ù‡∏±‡πà‡∏á Client
        let fuse; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Fuzzy Search
        const addItemModal = new bootstrap.Modal(document.getElementById('addItemModal'));

        // --- Auth Functions ---
        window.login = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try { await signInWithEmailAndPassword(auth, email, password); } 
            catch (e) { alert(e.message); }
        };

        window.register = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try { 
                await createUserWithEmailAndPassword(auth, email, password);
                alert("‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"); 
            } catch (e) { alert(e.message); }
        };

        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-section').classList.add('d-none');
                document.getElementById('app-section').classList.remove('d-none');
                document.getElementById('nav-controls').innerHTML = `
                    <span class="navbar-text text-white me-3">${user.email}</span>
                    <button onclick="logout()" class="btn btn-sm btn-outline-light">Logout</button>
                `;
            } else {
                currentUser = null;
                document.getElementById('auth-section').classList.remove('d-none');
                document.getElementById('app-section').classList.add('d-none');
            }
        });

        // --- Map & Logic ---
        
        // 1. Load Items
        window.loadItems = async () => {
            const code = document.getElementById('active-code').value;
            if (!code) return;

            const q = query(collection(db, "items"), where("secretCode", "==", code));
            const snapshot = await getDocs(q);
            
            allItems = [];
            snapshot.forEach(doc => allItems.push({ id: doc.id, ...doc.data() }));

            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Fuzzy Search (Fuse.js)
            // keys: ‡∏Ñ‡∏∑‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤, threshold: 0.4 ‡∏Ñ‡∏∑‡∏≠‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏ú‡∏¥‡∏î‡πÑ‡∏î‡πâ‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢ (0 ‡∏Ñ‡∏∑‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πä‡∏∞, 1 ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡πá‡πÑ‡∏î‡πâ)
            const options = { includeScore: true, keys: ['name', 'category'], threshold: 0.4 };
            fuse = new Fuse(allItems, options);

            renderMap(allItems);
            renderList(allItems);
        };

        // 2. Render Functions
        function renderMap(items) {
            const container = document.getElementById('map-container');
            // ‡∏•‡∏ö Markers ‡πÄ‡∏Å‡πà‡∏≤ (‡πÄ‡∏Å‡πá‡∏ö‡∏û‡∏ß‡∏Å map-image ‡πÅ‡∏•‡∏∞ badge ‡πÑ‡∏ß‡πâ)
            const oldMarkers = container.querySelectorAll('.marker');
            oldMarkers.forEach(el => el.remove());

            items.forEach(item => {
                const el = document.createElement('div');
                el.className = 'marker';
                el.innerHTML = `<i class="fas fa-map-marker-alt"></i><div class="marker-label">${item.name}</div>`;
                el.style.left = item.x + '%';
                el.style.top = item.y + '%';
                el.dataset.id = item.id;
                
                // ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á)
                if(item.userId === currentUser.uid) {
                    el.onclick = (e) => {
                        e.stopPropagation();
                        if(confirm(`‡∏•‡∏ö ${item.name}?`)) deleteItem(item.id);
                    }
                }
                container.appendChild(el);
            });
        }

        function renderList(items) {
            const list = document.getElementById('item-list');
            list.innerHTML = '';
            if(items.length === 0) {
                list.innerHTML = '<li class="list-group-item text-center text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ</li>';
                return;
            }

            items.forEach(item => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `
                    <div>
                        <strong>${item.name}</strong><br>
                        <small class="text-muted badge bg-light text-dark border">${item.category}</small>
                    </div>
                    <button class="btn btn-sm btn-outline-info" onclick="focusItem('${item.id}')"><i class="fas fa-eye"></i></button>
                `;
                list.appendChild(li);
            });
        }

        // 3. Add Item Flow
        document.getElementById('map-container').addEventListener('click', (e) => {
            // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ñ‡πâ‡∏≤‡∏Å‡∏î‡∏ó‡∏µ‡πà marker
            if(e.target.closest('.marker')) return;
            
            const code = document.getElementById('active-code').value;
            if(!code) return alert("‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");

            const rect = e.currentTarget.getBoundingClientRect();
            const x = ((e.clientX - rect.left) / rect.width) * 100;
            const y = ((e.clientY - rect.top) / rect.height) * 100;

            document.getElementById('new-x').value = x;
            document.getElementById('new-y').value = y;
            document.getElementById('item-name').value = '';
            
            addItemModal.show();
        });

        window.saveItem = async () => {
            const name = document.getElementById('item-name').value;
            const category = document.getElementById('item-category').value;
            const x = parseFloat(document.getElementById('new-x').value);
            const y = parseFloat(document.getElementById('new-y').value);
            const code = document.getElementById('active-code').value;

            if(!name) return;

            try {
                await addDoc(collection(db, "items"), {
                    userId: currentUser.uid,
                    name, category, x, y, secretCode: code,
                    timestamp: new Date()
                });
                addItemModal.hide();
                loadItems();
            } catch (e) { console.error(e); }
        };

        window.deleteItem = async (id) => {
            await deleteDoc(doc(db, "items", id));
            loadItems();
        };

        // 4. Smart Search Logic (‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö Fuzzy)
        document.getElementById('search-box').addEventListener('keyup', (e) => {
            const term = e.target.value;
            
            if (!term) {
                // ‡∏ñ‡πâ‡∏≤‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                renderMap(allItems);
                renderList(allItems);
                return;
            }

            // ‡πÉ‡∏ä‡πâ Fuse.js ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)
            const results = fuse.search(term).map(r => r.item);
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï List ‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤
            renderList(results);

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Map: ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏à‡∏≤‡∏á‡∏•‡∏á (Dim)
            const markers = document.querySelectorAll('.marker');
            markers.forEach(m => {
                const isMatch = results.find(r => r.id === m.dataset.id);
                if (isMatch) {
                    m.classList.remove('dimmed');
                    m.classList.add('highlighted');
                } else {
                    m.classList.add('dimmed');
                    m.classList.remove('highlighted');
                }
            });
        });
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏î‡∏π" ‡πÉ‡∏ô List ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏°‡∏û‡∏à‡∏∞‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå
        window.focusItem = (id) => {
            const markers = document.querySelectorAll('.marker');
            markers.forEach(m => {
                if (m.dataset.id === id) {
                    m.classList.remove('dimmed');
                    m.classList.add('highlighted');
                } else {
                    m.classList.add('dimmed');
                    m.classList.remove('highlighted');
                }
            });
        };
    </script>
</body>
</html>
