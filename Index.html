<!DOCTYPE html>
<html lang="th" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PayLink Secure Gateway</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lazywasabi/thai-bank-icons@master/dist/css/thai-bank-icons.css">
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --bg-main: #020617;
            --glass-bg: rgba(30, 41, 59, 0.7);
            --primary: #6366f1;
            --text-main: #f8fafc;
        }

        /* Global & Reset */
        * { box-sizing: border-box; outline: none; }
        body {
            font-family: 'Prompt', sans-serif;
            background-color: var(--bg-main);
            background-image: radial-gradient(circle at 50% -20%, #1e1b4b, #020617);
            color: var(--text-main);
            min-height: 100vh;
            margin: 0; padding: 0;
            overflow-x: hidden;
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        /* View Control */
        section { display: none !important; }
        section.active-view { display: block !important; }

        /* Admin Layout */
        .admin-container {
            display: grid; grid-template-columns: 260px 1fr; gap: 20px;
            max-width: 1400px; margin: 0 auto; padding: 20px; min-height: 100vh;
        }
        .sidebar {
            background: rgba(15, 23, 42, 0.9); border-right: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px; padding: 20px; position: sticky; top: 20px; height: calc(100vh - 40px);
            display: flex; flex-direction: column;
        }
        .nav-item {
            padding: 12px; margin-bottom: 5px; border-radius: 10px; color: #94a3b8; cursor: pointer;
            display: flex; align-items: center; gap: 12px; transition: 0.2s;
        }
        .nav-item:hover, .nav-item.active { background: rgba(99, 102, 241, 0.15); color: var(--primary); }

        /* Client Card */
        .client-card {
            background: rgba(30, 41, 59, 0.4); border: 1px solid rgba(255,255,255,0.05);
            border-radius: 12px; padding: 20px; transition: 0.2s; border-left: 4px solid #6366f1;
        }
        .client-card:hover { transform: translateY(-3px); background: rgba(30, 41, 59, 0.8); }
        .action-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 15px; }
        
        .btn-action {
            border: none; padding: 8px; border-radius: 8px; font-size: 0.8rem;
            display: flex; align-items: center; justify-content: center; gap: 5px; cursor: pointer; transition: 0.2s;
        }
        .btn-bank { background: rgba(99, 102, 241, 0.15); color: #818cf8; } .btn-bank:hover { background: #6366f1; color: white; }
        .btn-time { background: rgba(16, 185, 129, 0.15); color: #34d399; } .btn-time:hover { background: #10b981; color: white; }
        .btn-del { background: rgba(239, 68, 68, 0.15); color: #f87171; } .btn-del:hover { background: #ef4444; color: white; }

        /* Public View */
        .public-wrapper { max-width: 480px; margin: 0 auto; padding: 40px 20px; min-height: 100vh; display: flex; flex-direction: column; justify-content: center; }
        .bank-item {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.05);
            padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; align-items: center; cursor: pointer;
        }

        /* Responsive */
        @media (max-width: 992px) {
            .admin-container { grid-template-columns: 1fr; padding: 10px; }
            .sidebar { height: auto; position: static; margin-bottom: 20px; flex-direction: row; padding: 10px; overflow-x: auto; }
            .nav-item { white-space: nowrap; margin-bottom: 0; margin-right: 10px; }
        }
        
        /* Modal Fix */
        .modal-content { background: #1e293b; color: white; border: 1px solid rgba(255,255,255,0.1); }
        .form-control-dark { background: #0f172a; border: 1px solid #334155; color: white; }
        .form-control-dark:focus { background: #0f172a; color: white; border-color: var(--primary); box-shadow: none; }
    </style>
</head>
<body>

    <section id="view-loading" class="active-view">
        <div class="d-flex justify-content-center align-items-center vh-100 flex-column">
            <div class="spinner-border text-primary mb-3"></div>
            <div class="small text-white-50">LOADING SYSTEM...</div>
        </div>
    </section>

    <section id="view-client">
        <div class="public-wrapper">
            <div class="glass-panel p-4 text-center">
                <div id="alert-expired" class="alert alert-danger d-none border-0 bg-danger bg-opacity-25 text-white mb-4">
                    <i class="fas fa-lock me-2"></i> ลิงก์หมดอายุ
                </div>
                
                <i class="fas fa-wallet fa-3x text-primary mb-3"></i>
                <h3 id="client-name-display" class="fw-bold mb-1">...</h3>
                <p class="text-white-50 small mb-4">Secure Payment Gateway</p>

                <div id="client-bank-container" class="text-start mb-4"></div>

                <a id="client-fb-link" href="#" target="_blank" class="btn btn-primary w-100 rounded-pill">
                    <i class="fab fa-facebook-messenger me-2"></i> ติดต่อแอดมิน
                </a>
                
                <div class="mt-4 pt-4 border-top border-white border-opacity-10">
                    <span class="text-white-50 small cursor-pointer opacity-25" onclick="app.secretTrigger()">Admin Login</span>
                </div>
            </div>
        </div>
    </section>

    <section id="view-login">
        <div class="d-flex justify-content-center align-items-center vh-100">
            <div class="glass-panel p-5" style="width: 100%; max-width: 400px;">
                <h4 class="fw-bold mb-4 text-center">Admin Access</h4>
                <form onsubmit="app.handleLogin(event)">
                    <input type="email" id="login-email" class="form-control form-control-dark mb-3" placeholder="Email" required>
                    <input type="password" id="login-pass" class="form-control form-control-dark mb-4" placeholder="Password" required>
                    <button type="submit" class="btn btn-primary w-100">เข้าสู่ระบบ</button>
                </form>
            </div>
        </div>
    </section>

    <section id="view-dashboard">
        <div class="admin-container">
            <div class="sidebar">
                <div class="mb-4 ps-2"><h4 class="fw-bold m-0"><span class="text-primary">Pay</span>Link</h4></div>
                <nav>
                    <div class="nav-item active" onclick="app.switchTab('clients', this)"><i class="fas fa-users"></i> ลูกค้า</div>
                    <div class="nav-item" onclick="app.switchTab('settings', this)"><i class="fas fa-cog"></i> ตั้งค่า</div>
                </nav>
                <div class="mt-auto pt-3 border-top border-white border-opacity-10">
                    <button onclick="app.logout()" class="btn btn-outline-danger btn-sm w-100">Logout</button>
                </div>
            </div>

            <div class="main-content">
                <div id="tab-clients">
                    <div class="glass-panel p-3 mb-4 d-flex flex-wrap gap-3 justify-content-between align-items-end">
                        <div class="flex-grow-1">
                            <label class="small text-white-50">ค้นหา</label>
                            <input type="text" id="search-input" onkeyup="app.filterClients()" class="form-control form-control-dark" placeholder="ชื่อลูกค้า...">
                        </div>
                        <div class="d-flex gap-2 align-items-end">
                            <div><label class="small text-white-50">ชื่อใหม่</label><input id="new-client-name" class="form-control form-control-dark"></div>
                            <div><label class="small text-white-50">วัน</label><input type="number" id="new-client-days" class="form-control form-control-dark" value="30" style="width:70px;"></div>
                            <button onclick="app.createClient()" class="btn btn-primary">เพิ่ม</button>
                        </div>
                    </div>
                    <div id="clients-grid" class="row g-3"></div>
                </div>

                <div id="tab-settings" class="d-none">
                    <div class="glass-panel p-4" style="max-width: 600px;">
                        <h5 class="mb-3">ตั้งค่าระบบ</h5>
                        <label class="text-white-50 mb-1">ลิงก์ติดต่อ (Facebook/Line)</label>
                        <input type="text" id="config-fb" class="form-control form-control-dark mb-3">
                        <button onclick="app.saveConfig()" class="btn btn-success">บันทึก</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div class="modal fade" id="bankModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-secondary border-opacity-25">
                    <h5 class="modal-title">จัดการบัญชี: <span id="modal-client-name" class="text-primary"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <label class="small text-white-50 mb-2">เลือกธนาคาร</label>
                    <div class="d-flex flex-wrap gap-2 mb-3" id="bank-selector-area"></div>
                    <input type="hidden" id="selected-bank-code">

                    <div class="input-group mb-4">
                        <input type="text" id="input-acc-num" class="form-control form-control-dark" placeholder="เลขบัญชี">
                        <button onclick="app.addBankAccount()" class="btn btn-primary">เพิ่ม</button>
                    </div>

                    <div id="modal-bank-list" class="bg-black bg-opacity-25 rounded p-2" style="max-height: 250px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, deleteDoc, updateDoc, doc, setDoc, onSnapshot, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDT39HkTA1TLFKvuQNZcrNeIZMLANgy2z0",
            authDomain: "scan-4b703.firebaseapp.com",
            projectId: "scan-4b703",
            storageBucket: "scan-4b703.firebasestorage.app",
            messagingSenderId: "667992011250",
            appId: "1:667992011250:web:adce534c0f97b4ddb47b6b"
        };
        const ADMIN_EMAIL = "fafa@gmail.com";
        const BANKS = [
            {id:'kbank',n:'กสิกร',i:'pf-kbank',c:'#00cc6a'}, {id:'scb',n:'ไทยพาณิชย์',i:'pf-scb',c:'#4e2e7f'},
            {id:'ktb',n:'กรุงไทย',i:'pf-krungthai',c:'#00a5e5'}, {id:'bbl',n:'กรุงเทพ',i:'pf-bbl',c:'#1e4598'},
            {id:'gsb',n:'ออมสิน',i:'pf-gsb',c:'#eb198d'}, {id:'truemoney',n:'TrueMoney',i:'pf-wallet',c:'#ff5c00'},
            {id:'promptpay',n:'พร้อมเพย์',i:'pf-promptpay',c:'#1c3d6e'}, {id:'ttb',n:'ทีทีบี',i:'pf-ttb',c:'#0050f0'}
        ];

        class PayLinkApp {
            constructor() {
                this.app = initializeApp(firebaseConfig);
                this.auth = getAuth(this.app);
                this.db = getFirestore(this.app);
                this.clickCount = 0;
                this.modalInstance = null;
                this.currentEditingId = null;
                this.init();
            }

            init() {
                const params = new URLSearchParams(window.location.search);
                const code = params.get('code');
                const admin = params.get('admin');

                if (code) this.loadClientView(code);
                else if (admin === 'login') this.showView('view-login');
                else {
                    onAuthStateChanged(this.auth, u => {
                        if (u && u.email === ADMIN_EMAIL) this.initAdminDashboard(u);
                        else this.showView('view-loading'); 
                    });
                }
            }

            showView(id) {
                document.querySelectorAll('section').forEach(e => e.classList.remove('active-view'));
                document.getElementById(id).classList.add('active-view');
            }

            // --- CLIENT ---
            async loadClientView(code) {
                try {
                    const snap = await getDocs(query(collection(this.db, "clients"), where("code", "==", code)));
                    if (snap.empty) { Swal.fire('Error', 'ไม่พบข้อมูล', 'error'); return; }
                    
                    const data = snap.docs[0].data();
                    document.getElementById('client-name-display').innerText = data.name;
                    this.showView('view-client');
                    
                    getDoc(doc(this.db,"system_config","main")).then(d=>{if(d.exists()) document.getElementById('client-fb-link').href = d.data().fbLink||'#'});

                    if (Date.now() > data.expireAt) {
                        document.getElementById('alert-expired').classList.remove('d-none');
                        document.getElementById('client-bank-container').innerHTML = '<p class="text-white-50 text-center">ระบบระงับการใช้งานชั่วคราว</p>';
                    } else {
                        this.renderPublicBanks(snap.docs[0].id);
                    }
                } catch(e) { console.error(e); }
            }

            renderPublicBanks(id) {
                const el = document.getElementById('client-bank-container');
                onSnapshot(query(collection(this.db, "bank_accounts"), where("clientId", "==", id)), snap => {
                    el.innerHTML = '';
                    snap.forEach(d => {
                        const b = d.data();
                        const i = BANKS.find(x => x.id === b.bank) || BANKS[0];
                        el.innerHTML += `
                        <div class="bank-item" onclick="app.copy('${b.accNum}')">
                            <div class="bg-white rounded p-2 me-3 d-flex align-items-center"><i class="pf ${i.i} fs-3" style="color:${i.c}"></i></div>
                            <div class="flex-grow-1"><div class="small text-white-50">${i.n}</div><div class="fs-5 fw-bold font-monospace">${b.accNum}</div></div>
                            <button class="btn btn-sm btn-dark rounded-pill px-3">Copy</button>
                        </div>`;
                    });
                });
            }

            copy(t) { navigator.clipboard.writeText(t); Swal.fire({toast:true,icon:'success',title:'Copied',position:'top',showConfirmButton:false,timer:1000}); }
            secretTrigger() { if(++this.clickCount >= 5) { this.clickCount=0; this.showView('view-login'); } }

            // --- ADMIN ---
            async handleLogin(e) {
                e.preventDefault();
                try {
                    await signInWithEmailAndPassword(this.auth, document.getElementById('login-email').value, document.getElementById('login-pass').value);
                } catch(err) { Swal.fire('Error', err.message, 'error'); }
            }
            logout() { signOut(this.auth).then(()=>window.location.reload()); }

            initAdminDashboard(u) {
                this.showView('view-dashboard');
                getDoc(doc(this.db,"system_config","main")).then(d=>{if(d.exists()) document.getElementById('config-fb').value=d.data().fbLink||''});
                
                // Render Bank Selector in Modal
                const area = document.getElementById('bank-selector-area');
                area.innerHTML = '';
                BANKS.forEach(b => {
                    area.innerHTML += `<div class="p-2 rounded cursor-pointer border border-secondary border-opacity-25 text-center bank-opt" onclick="app.selectBank('${b.id}',this)" style="width:60px;"><i class="pf ${b.i} fs-4 mb-1" style="color:${b.c}"></i><div style="font-size:8px;">${b.n}</div></div>`;
                });

                // Load Clients
                onSnapshot(query(collection(this.db,"clients"), orderBy("createdAt","desc")), snap => {
                    const grid = document.getElementById('clients-grid'); grid.innerHTML = '';
                    snap.forEach(d => {
                        const data = d.data();
                        const days = Math.ceil((data.expireAt - Date.now())/86400000);
                        const exp = days <= 0;
                        grid.innerHTML += `
                        <div class="col-md-6 col-lg-4 client-item">
                            <div class="client-card">
                                <div class="d-flex justify-content-between mb-2">
                                    <h5 class="m-0 fw-bold">${data.name}</h5>
                                    <span class="badge ${exp?'bg-danger':'bg-success'}">${exp?'Expired':days+' วัน'}</span>
                                </div>
                                <div class="bg-black bg-opacity-50 p-2 rounded d-flex justify-content-between mb-3">
                                    <code class="text-info">${data.code}</code>
                                    <button class="btn btn-sm btn-link text-white-50 p-0" onclick="app.copy('${window.location.origin}?code=${data.code}')">Link</button>
                                </div>
                                <div class="action-grid">
                                    <button class="btn-action btn-bank" onclick="app.openBankModal('${d.id}','${data.name}')"><i class="fas fa-wallet"></i> บัญชี</button>
                                    <button class="btn-action btn-time" onclick="app.extend('${d.id}')"><i class="fas fa-history"></i> ต่ออายุ</button>
                                    <button class="btn-action btn-del" onclick="app.delClient('${d.id}')"><i class="fas fa-trash"></i> ลบ</button>
                                </div>
                            </div>
                        </div>`;
                    });
                });
            }

            // --- ADMIN ACTIONS ---
            async createClient() {
                const name = document.getElementById('new-client-name').value;
                if(!name) return Swal.fire('Error','ใส่ชื่อลูกค้า','warning');
                const code = 'PAY-'+Math.random().toString(36).substring(2,6).toUpperCase();
                const exp = Date.now() + (parseInt(document.getElementById('new-client-days').value)*86400000);
                await addDoc(collection(this.db,"clients"), { name, code, expireAt: exp, createdAt: Date.now() });
                document.getElementById('new-client-name').value='';
                Swal.fire({toast:true,icon:'success',title:'Created: '+code});
            }
            
            async delClient(id) {
                if((await Swal.fire({title:'ลบลูกค้า?',icon:'warning',showCancelButton:true})).isConfirmed) deleteDoc(doc(this.db,"clients",id));
            }
            
            async extend(id) {
                const {value} = await Swal.fire({title:'เพิ่มวัน',input:'number',inputValue:30});
                if(value) {
                    const snap = await getDoc(doc(this.db,"clients",id));
                    const base = Math.max(snap.data().expireAt, Date.now());
                    updateDoc(doc(this.db,"clients",id), {expireAt: base + (parseInt(value)*86400000)});
                    Swal.fire({toast:true,icon:'success',title:'Extended'});
                }
            }

            selectBank(id, el) {
                document.querySelectorAll('.bank-opt').forEach(e=>e.classList.remove('bg-primary','bg-opacity-25'));
                el.classList.add('bg-primary','bg-opacity-25');
                document.getElementById('selected-bank-code').value = id;
            }

            openBankModal(id, name) {
                this.currentEditingId = id;
                document.getElementById('modal-client-name').innerText = name;
                document.getElementById('input-acc-num').value = '';
                
                // Init Modal
                const el = document.getElementById('bankModal');
                this.modalInstance = new bootstrap.Modal(el);
                this.modalInstance.show();

                // Load List
                const list = document.getElementById('modal-bank-list');
                list.innerHTML = '<div class="text-center p-2"><div class="spinner-border spinner-border-sm"></div></div>';
                
                onSnapshot(query(collection(this.db,"bank_accounts"), where("clientId","==",id)), snap => {
                    list.innerHTML = '';
                    if(snap.empty) { list.innerHTML='<p class="text-center text-white-50 small mt-2">ไม่มีบัญชี</p>'; return; }
                    snap.forEach(d => {
                        const b = d.data();
                        const i = BANKS.find(x=>x.id===b.bank) || BANKS[0];
                        list.innerHTML += `<div class="d-flex justify-content-between align-items-center bg-white bg-opacity-10 p-2 rounded mb-2"><div class="d-flex align-items-center gap-2"><i class="pf ${i.i}" style="color:${i.c}"></i> <span>${b.accNum}</span></div><button onclick="app.delBank('${d.id}')" class="btn btn-sm btn-danger py-0"><i class="fas fa-times"></i></button></div>`;
                    });
                }, err => {
                    console.log(err);
                    if(err.message.includes('index')) Swal.fire({icon:'warning', title:'ต้องการ Index', html:`<a href="${err.message.match(/https:\/\/[^ ]+/)[0]}" target="_blank">กดสร้าง Index ที่นี่</a>`});
                });
            }

            async addBankAccount() {
                const bank = document.getElementById('selected-bank-code').value;
                const acc = document.getElementById('input-acc-num').value;
                if(!bank || !acc) return;
                await addDoc(collection(this.db,"bank_accounts"), { clientId: this.currentEditingId, bank, accNum: acc });
                document.getElementById('input-acc-num').value = '';
            }
            delBank(id) { deleteDoc(doc(this.db,"bank_accounts",id)); }

            switchTab(t, el) {
                document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); el.classList.add('active');
                document.getElementById('tab-clients').classList.add('d-none');
                document.getElementById('tab-settings').classList.add('d-none');
                document.getElementById('tab-'+t).classList.remove('d-none');
            }
            async saveConfig() {
                await setDoc(doc(this.db,"system_config","main"), {fbLink: document.getElementById('config-fb').value});
                Swal.fire('Saved','','success');
            }
            filterClients() {
                const v = document.getElementById('search-input').value.toLowerCase();
                document.querySelectorAll('.client-item').forEach(e => e.style.display = e.innerText.toLowerCase().includes(v)?'block':'none');
            }
        }

        window.app = new PayLinkApp();
    </script>
</body>
</html>
