<!DOCTYPE html>
<html lang="th" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PayLink Admin System</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lazywasabi/thai-bank-icons@master/dist/css/thai-bank-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { --bg-dark: #0f172a; --card-bg: #1e293b; --primary: #6366f1; }
        body { font-family: 'Prompt', sans-serif; background: var(--bg-dark); color: #e2e8f0; min-height: 100vh; }
        
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .admin-panel { border-left: 4px solid var(--primary); }
        
        .bank-card {
            background: linear-gradient(145deg, #334155, #1e293b); border-radius: 12px; padding: 15px; margin-bottom: 10px;
            border: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: space-between;
        }
        .bank-logo { width: 45px; height: 45px; background: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 22px; margin-right: 15px; }
        .acc-num { font-family: monospace; font-size: 1.2rem; font-weight: bold; letter-spacing: 1px; color: #fff; }
        
        .status-badge { font-size: 0.8rem; padding: 4px 10px; border-radius: 20px; }
        .status-active { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .status-expired { background: rgba(239, 68, 68, 0.2); color: #f87171; }

        .admin-trigger { position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; border-radius: 50%; background: #333; border: none; opacity: 0.1; transition: 0.3s; z-index: 999; }
        .admin-trigger:hover { opacity: 1; background: var(--primary); }
    </style>
</head>
<body>

    <div class="container py-4">

        <div id="client-view" class="d-none">
            <div class="text-center mb-4">
                <div id="client-status-alert" class="alert alert-danger d-none mb-3">
                    <i class="fas fa-exclamation-circle me-2"></i> บัญชีนี้หมดอายุการใช้งาน
                </div>
                <h2 id="client-name-display" class="fw-bold text-white">...</h2>
                <p class="text-muted small">ช่องทางชำระเงิน</p>
            </div>

            <div id="public-bank-list" style="max-width: 500px; margin: 0 auto;"></div>

            <div class="text-center mt-5">
                <p class="text-muted small mb-2">ต้องการแก้ไขข้อมูล / ต่ออายุ?</p>
                <a id="admin-fb-link" href="#" target="_blank" class="btn btn-outline-primary rounded-pill px-4">
                    <i class="fab fa-facebook-messenger me-2"></i> ติดต่อแอดมิน
                </a>
            </div>
        </div>

        <div id="admin-dashboard" class="d-none">
            <div class="d-flex justify-content-between align-items-center mb-4 glass-card p-3 admin-panel">
                <div>
                    <h4 class="m-0 fw-bold text-primary"><i class="fas fa-user-shield"></i> Admin Control</h4>
                    <small class="text-muted">Logged in as: <span id="admin-display-email"></span></small>
                </div>
                <button onclick="logout()" class="btn btn-sm btn-danger">Logout</button>
            </div>

            <div class="glass-card p-3 mb-4">
                <label class="small text-muted mb-1">ลิ้งค์ Facebook ของคุณ</label>
                <div class="input-group">
                    <input type="text" id="config-fb" class="form-control bg-dark text-white border-secondary" placeholder="https://m.me/yourid">
                    <button class="btn btn-primary" onclick="saveConfig()"><i class="fas fa-save"></i></button>
                </div>
            </div>

            <div class="glass-card p-4 mb-4">
                <h5 class="fw-bold mb-3"><i class="fas fa-user-plus me-2"></i>สร้างบัญชีลูกค้าใหม่</h5>
                <div class="row g-2">
                    <div class="col-md-4"><input id="new-name" class="form-control bg-dark text-white" placeholder="ชื่อลูกค้า"></div>
                    <div class="col-md-3"><input id="new-code" class="form-control bg-dark text-white" placeholder="รหัสลับ (Ex. A1B2)"></div>
                    <div class="col-md-3"><input type="number" id="new-days" class="form-control bg-dark text-white" placeholder="จำนวนวันใช้งาน (30)"></div>
                    <div class="col-md-2"><button onclick="createClient()" class="btn btn-success w-100">สร้าง</button></div>
                </div>
            </div>

            <h5 class="text-white mb-3">รายชื่อลูกค้าทั้งหมด</h5>
            <div id="client-list-admin" class="row"></div>
        </div>

        <div class="modal fade" id="bankModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content glass-card bg-dark">
                    <div class="modal-header border-secondary">
                        <h5 class="modal-title text-white">จัดการธนาคารของ <span id="modal-client-name" class="text-primary"></span></h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="input-group mb-3">
                            <select id="add-bank-type" class="form-select bg-dark text-white border-secondary">
                                <option value="kbank">กสิกรไทย</option><option value="scb">ไทยพาณิชย์</option>
                                <option value="ktb">กรุงไทย</option><option value="bbl">กรุงเทพ</option>
                                <option value="truemoney">TrueMoney</option><option value="promptpay">พร้อมเพย์</option>
                            </select>
                            <input id="add-acc-num" class="form-control bg-dark text-white border-secondary" placeholder="เลขบัญชี">
                            <button onclick="addBankToClient()" class="btn btn-primary"><i class="fas fa-plus"></i></button>
                        </div>
                        <hr class="border-secondary">
                        <div id="modal-bank-list"></div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <button onclick="openLogin()" class="admin-trigger"><i class="fas fa-key text-white"></i></button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, deleteDoc, updateDoc, doc, setDoc, onSnapshot, getDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDT39HkTA1TLFKvuQNZcrNeIZMLANgy2z0",
            authDomain: "scan-4b703.firebaseapp.com",
            projectId: "scan-4b703",
            storageBucket: "scan-4b703.firebasestorage.app",
            messagingSenderId: "667992011250",
            appId: "1:667992011250:web:adce534c0f97b4ddb47b6b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // --- แก้ไขอีเมลแอดมินตรงนี้ ---
        const ADMIN_EMAIL = "fafa@gmail.com";
        // -----------------------------

        let currentAdmin = null;
        let editingClientId = null;

        window.onload = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            loadGlobalConfig();
            if(code) loadClientView(code);
        };

        async function loadGlobalConfig() {
            try {
                const docSnap = await getDoc(doc(db, "system_config", "main"));
                if (docSnap.exists()) {
                    const link = docSnap.data().fbLink || "#";
                    document.getElementById('admin-fb-link').href = link;
                    document.getElementById('config-fb').value = link;
                }
            } catch(e) {}
        }

        onAuthStateChanged(auth, (user) => {
            if (user && user.email === ADMIN_EMAIL) {
                currentAdmin = user;
                document.getElementById('admin-dashboard').classList.remove('d-none');
                document.getElementById('client-view').classList.add('d-none');
                document.getElementById('admin-display-email').innerText = user.email;
                loadAllClients();
            } else {
                currentAdmin = null;
                document.getElementById('admin-dashboard').classList.add('d-none');
            }
        });

        window.openLogin = async () => {
            if(currentAdmin) return;
            const { value: formValues } = await Swal.fire({
                title: 'Admin Only',
                html: '<input id="swal-email" class="swal2-input" placeholder="Email"><input id="swal-pass" type="password" class="swal2-input" placeholder="Password">',
                focusConfirm: false,
                preConfirm: () => [document.getElementById('swal-email').value, document.getElementById('swal-pass').value]
            });
            if (formValues) {
                // เช็คตรงนี้ก่อนส่งไป Firebase
                if(formValues[0] !== ADMIN_EMAIL) return Swal.fire('Error', 'คุณไม่ใช่แอดมินระบบนี้ (Email ไม่ตรง)', 'error');
                
                try {
                    await signInWithEmailAndPassword(auth, formValues[0], formValues[1]);
                    Swal.fire('Welcome Admin', '', 'success');
                } catch (e) { Swal.fire('Login Failed', e.message, 'error'); }
            }
        };

        window.logout = () => signOut(auth);

        window.createClient = async () => {
            const name = document.getElementById('new-name').value;
            const code = document.getElementById('new-code').value.toUpperCase();
            const days = parseInt(document.getElementById('new-days').value) || 30;
            if(!name || !code) return Swal.fire('กรอกข้อมูลให้ครบ','','warning');
            
            const expireDate = new Date();
            expireDate.setDate(expireDate.getDate() + days);

            try {
                const q = query(collection(db, "clients"), where("code", "==", code));
                const snap = await getDocs(q);
                if(!snap.empty) return Swal.fire('รหัสซ้ำ', 'เปลี่ยนรหัสลับใหม่', 'error');

                await addDoc(collection(db, "clients"), { name: name, code: code, expireAt: expireDate.getTime(), createdAt: Date.now() });
                Swal.fire('สร้างลูกค้าสำเร็จ', `ลิ้งค์: ?code=${code}`, 'success');
                document.getElementById('new-name').value = ''; document.getElementById('new-code').value = '';
            } catch(e) { Swal.fire('Error', e.message, 'error'); }
        };

        function loadAllClients() {
            onSnapshot(query(collection(db, "clients"), orderBy("createdAt", "desc")), (snap) => {
                const list = document.getElementById('client-list-admin'); list.innerHTML = '';
                snap.forEach(d => {
                    const data = d.data();
                    const isExpired = Date.now() > data.expireAt;
                    const timeLeft = Math.ceil((data.expireAt - Date.now()) / (1000 * 60 * 60 * 24));
                    const statusClass = isExpired ? 'status-expired' : 'status-active';
                    const statusText = isExpired ? 'หมดอายุแล้ว' : `เหลือ ${timeLeft} วัน`;
                    list.innerHTML += `
                    <div class="col-md-6 mb-3">
                        <div class="glass-card p-3">
                            <div class="d-flex justify-content-between mb-2">
                                <h5 class="fw-bold text-white mb-0">${data.name}</h5>
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </div>
                            <div class="text-muted small">Code: <span class="text-info">${data.code}</span></div>
                            <div class="text-muted small mb-3">Link: <u class="text-white">${window.location.origin}${window.location.pathname}?code=${data.code}</u></div>
                            <div class="d-flex gap-2">
                                <button onclick="openBankModal('${d.id}', '${data.name}')" class="btn btn-sm btn-outline-light">บัญชี</button>
                                <button onclick="extendTime('${d.id}')" class="btn btn-sm btn-outline-success">ต่ออายุ</button>
                                <button onclick="deleteClient('${d.id}')" class="btn btn-sm btn-outline-danger">ลบ</button>
                            </div>
                        </div>
                    </div>`;
                });
            });
        }

        window.extendTime = async (id) => {
            const { value: days } = await Swal.fire({ title: 'เพิ่มวันใช้งาน', input: 'number', inputValue: 30 });
            if(days) {
                const newDate = new Date(); newDate.setDate(newDate.getDate() + parseInt(days));
                await updateDoc(doc(db, "clients", id), { expireAt: newDate.getTime() });
                Swal.fire('เรียบร้อย', '', 'success');
            }
        };

        window.deleteClient = async (id) => {
            if((await Swal.fire({title:'ลบลูกค้านี้?', icon:'warning', showCancelButton:true})).isConfirmed) await deleteDoc(doc(db, "clients", id));
        }
        window.saveConfig = async () => {
            await setDoc(doc(db, "system_config", "main"), { fbLink: document.getElementById('config-fb').value });
            Swal.fire('บันทึก Link แล้ว', '', 'success');
        }

        window.openBankModal = (clientId, clientName) => {
            editingClientId = clientId;
            document.getElementById('modal-client-name').innerText = clientName;
            loadClientBanks(clientId, 'modal-bank-list', true);
            new bootstrap.Modal(document.getElementById('bankModal')).show();
        };

        window.addBankToClient = async () => {
            const num = document.getElementById('add-acc-num').value;
            if(!num) return;
            await addDoc(collection(db, "bank_accounts"), { clientId: editingClientId, bank: document.getElementById('add-bank-type').value, accNum: num, createdAt: Date.now() });
            document.getElementById('add-acc-num').value = '';
        }

        window.deleteBank = async (bankId) => { await deleteDoc(doc(db, "bank_accounts", bankId)); }

        async function loadClientView(code) {
            const q = query(collection(db, "clients"), where("code", "==", code.toUpperCase()));
            const snap = await getDocs(q);
            if(snap.empty) return Swal.fire({icon: 'error', title: 'ไม่พบข้อมูล'});
            const client = snap.docs[0].data();
            if(Date.now() > client.expireAt) {
                document.getElementById('client-status-alert').classList.remove('d-none');
                document.getElementById('client-status-alert').innerHTML = '⛔ บัญชีหมดอายุ กรุณาติดต่อแอดมิน';
            } else { loadClientBanks(snap.docs[0].id, 'public-bank-list', false); }
            document.getElementById('client-name-display').innerText = client.name;
            document.getElementById('client-view').classList.remove('d-none');
        }

        function loadClientBanks(clientId, elementId, isAdmin) {
            onSnapshot(query(collection(db, "bank_accounts"), where("clientId", "==", clientId)), (snap) => {
                const el = document.getElementById(elementId); el.innerHTML = '';
                if(snap.empty && !isAdmin) el.innerHTML = '<p class="text-center text-muted">ไม่พบข้อมูลบัญชี</p>';
                snap.forEach(d => {
                    const b = d.data();
                    const info = getBankStyle(b.bank);
                    const delBtn = isAdmin ? `<button onclick="deleteBank('${d.id}')" class="btn btn-sm btn-danger ms-2"><i class="fas fa-times"></i></button>` : '';
                    const copyBtn = !isAdmin ? `<button class="btn btn-sm btn-light text-dark rounded-pill px-3" onclick="copy('${b.accNum}')">Copy</button>` : '';
                    el.innerHTML += `<div class="bank-card" style="border-left: 5px solid ${info.color}"><div class="d-flex align-items-center"><div class="bank-logo"><i class="pf ${info.icon}" style="color:${info.color}"></i></div><div><div class="small text-muted opacity-75">${info.name}</div><div class="acc-num">${formatAcc(b.accNum)}</div></div></div><div class="d-flex align-items-center">${copyBtn}${delBtn}</div></div>`;
                });
            });
        }

        function getBankStyle(t) {
            const m = { 'kbank':{name:'กสิกรไทย',c:'#00cc6a',i:'pf-kbank'},'scb':{name:'ไทยพาณิชย์',c:'#4e2e7f',i:'pf-scb'},'ktb':{name:'กรุงไทย',c:'#00a5e5',i:'pf-krungthai'},'bbl':{name:'กรุงเทพ',c:'#1e4598',i:'pf-bbl'},'truemoney':{name:'TrueMoney',c:'#ff5c00',i:'pf-wallet'},'promptpay':{name:'พร้อมเพย์',c:'#1c3d6e',i:'pf-promptpay'} };
            return m[t] || m['promptpay'];
        }
        const formatAcc = (n) => n.replace(/(\d{3})(\d{1,})(\d{4})/, "$1-$2-$3");
        window.copy = (t) => { navigator.clipboard.writeText(t); Swal.fire({toast:true,position:'top',icon:'success',title:'Copied',showConfirmButton:false,timer:800}); }
    </script>
</body>
</html>
