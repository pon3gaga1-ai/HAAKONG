<!DOCTYPE html>
<html lang="th" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PayLink - ช่องทางชำระเงิน</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lazywasabi/thai-bank-icons@master/dist/css/thai-bank-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --bg-dark: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.85);
            --primary: #3b82f6;
        }

        body {
            font-family: 'Prompt', sans-serif;
            background: radial-gradient(circle at center, #1e293b 0%, #020617 100%);
            min-height: 100vh;
            color: #f8fafc;
            padding-bottom: 50px;
        }

        /* Glassmorphism Card */
        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        /* Bank Card Design */
        .bank-card {
            position: relative;
            background: linear-gradient(145deg, #334155, #1e293b);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid rgba(255,255,255,0.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
            overflow: hidden;
        }
        .bank-card:hover { transform: translateY(-3px); }
        
        /* Bank Brand Colors & Gradients */
        .kbank-bg { background: linear-gradient(135deg, #00c65e, #004e26); }
        .scb-bg { background: linear-gradient(135deg, #4e2e7f, #28104e); }
        .ktb-bg { background: linear-gradient(135deg, #00a5e5, #004b6e); }
        .bbl-bg { background: linear-gradient(135deg, #1e4598, #0a1e45); }
        .gsb-bg { background: linear-gradient(135deg, #eb198d, #6e003c); }
        .ttb-bg { background: linear-gradient(135deg, #0050f0, #002266); }
        .promptpay-bg { background: linear-gradient(135deg, #1c3d6e, #0f172a); border: 1px solid #3b82f6; }
        .truemoney-bg { background: linear-gradient(135deg, #ff5c00, #9a3412); }

        .bank-logo {
            width: 50px; height: 50px;
            background: white; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .acc-number { font-family: 'Courier New', monospace; font-size: 1.6rem; font-weight: 700; letter-spacing: 1px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .copy-btn { background: rgba(255,255,255,0.2); color: white; border:none; padding: 5px 15px; border-radius: 20px; font-size: 0.85rem; transition:0.2s; }
        .copy-btn:hover { background: white; color: #333; }

        /* Profile & Header */
        .profile-section { text-align: center; margin-bottom: 30px; animation: fadeInDown 0.6s; }
        .profile-avatar { width: 80px; height: 80px; background: linear-gradient(45deg, #3b82f6, #8b5cf6); border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 2rem; box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
        
        .main-container { max-width: 600px; margin: 0 auto; padding: 20px; }
        
        /* Utility */
        .d-none { display: none !important; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: 0; } }

        /* Announcement */
        .alert-custom { background: rgba(234, 179, 8, 0.1); border: 1px solid rgba(234, 179, 8, 0.3); color: #facc15; border-radius: 12px; font-size: 0.95rem; }

        /* Floating Login Button (ซ่อนไว้มุมขวาล่าง) */
        .admin-login-btn { position: fixed; bottom: 20px; right: 20px; opacity: 0.3; transition: 0.3s; z-index: 100; }
        .admin-login-btn:hover { opacity: 1; }
    </style>
</head>
<body>

    <div class="main-container">

        <div id="view-section" class="d-none">
            <div class="profile-section">
                <div class="profile-avatar"><i class="fas fa-wallet text-white"></i></div>
                <h5 class="text-muted mb-1">ช่องทางชำระเงินของ</h5>
                <h2 class="fw-bold text-white mb-3" id="view-name">...</h2>
                <div id="view-announcement" class="d-none alert-custom p-3 mb-4 text-start"><i class="fas fa-bullhorn me-2"></i><span></span></div>
            </div>

            <div id="view-list" class="fade-in">
                </div>
            
            <div class="text-center mt-5">
                <small class="text-muted opacity-50">Powered by PayLink System</small>
            </div>
        </div>

        <div id="landing-section">
            <div class="text-center py-5">
                <h1 class="fw-bold mb-4 bg-gradient-text">PayLink</h1>
                <div class="glass-card p-4 mx-auto" style="max-width: 400px;">
                    <p class="text-muted mb-3">กรอกรหัสเพื่อดูบัญชี</p>
                    <div class="input-group mb-3">
                        <input type="text" id="search-code" class="form-control form-control-lg bg-dark text-white border-secondary text-center text-uppercase" placeholder="รหัส 6 หลัก">
                        <button class="btn btn-primary" onclick="manualSearch()"><i class="fas fa-search"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div id="admin-section" class="d-none">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="fw-bold m-0"><i class="fas fa-user-cog me-2"></i>จัดการบัญชี</h4>
                <button onclick="logout()" class="btn btn-sm btn-outline-danger">ออก</button>
            </div>

            <div class="glass-card p-3 mb-4 bg-primary bg-opacity-10 border-primary border-opacity-25">
                <label class="small text-primary fw-bold mb-2">✨ ลิงก์สำหรับส่งให้ลูกค้า (Direct Link)</label>
                <div class="input-group">
                    <input type="text" id="share-link-input" class="form-control form-control-sm bg-dark text-white border-0" readonly>
                    <button class="btn btn-primary btn-sm" onclick="copyShareLink()"><i class="fas fa-link"></i> คัดลอก</button>
                </div>
                <div class="mt-2 small text-muted">
                    รหัสลับ: <span id="my-secret-code" class="fw-bold text-white">...</span>
                </div>
            </div>
            
            <div class="mb-4">
                 <label class="small text-muted mb-1">ประกาศ (แจ้งเตือนลูกค้า)</label>
                 <div class="input-group">
                    <input type="text" id="my-msg" class="form-control bg-dark text-white border-secondary" placeholder="เช่น: วันนี้งดรับกสิกร">
                    <button class="btn btn-outline-secondary" onclick="saveMsg()"><i class="fas fa-save"></i></button>
                 </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="text-muted">รายการบัญชี</span>
                <button class="btn btn-sm btn-success rounded-pill px-3" onclick="openAddModal()"><i class="fas fa-plus"></i> เพิ่ม</button>
            </div>
            <div id="my-account-list"></div>
        </div>

        <div id="auth-modal" class="d-none position-fixed top-0 start-0 w-100 h-100 bg-black bg-opacity-75 d-flex align-items-center justify-content-center" style="z-index: 2000;">
            <div class="glass-card p-4" style="width: 90%; max-width: 350px;">
                <h4 class="fw-bold mb-3">เข้าสู่ระบบ</h4>
                <input type="email" id="login-email" class="form-control mb-2 bg-dark text-white" placeholder="Email">
                <input type="password" id="login-pass" class="form-control mb-3 bg-dark text-white" placeholder="Password">
                <button onclick="doLogin()" class="btn btn-primary w-100 mb-2">Login / Register</button>
                <button onclick="closeLogin()" class="btn btn-outline-secondary w-100">ยกเลิก</button>
            </div>
        </div>

    </div>

    <button onclick="showLogin()" class="btn btn-dark rounded-circle admin-login-btn shadow" style="width: 50px; height: 50px;"><i class="fas fa-lock"></i></button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, deleteDoc, updateDoc, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDT39HkTA1TLFKvuQNZcrNeIZMLANgy2z0",
            authDomain: "scan-4b703.firebaseapp.com",
            projectId: "scan-4b703",
            storageBucket: "scan-4b703.firebasestorage.app",
            messagingSenderId: "667992011250",
            appId: "1:667992011250:web:adce534c0f97b4ddb47b6b",
            measurementId: "G-X5QG9YZWG6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;

        // --- 1. System Start: Check URL Params ---
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code'); // ดึงค่า ?code=...
            if (code) {
                // ถ้ามี code ในลิงก์ ให้ค้นหาทันที และซ่อนหน้า landing
                document.getElementById('landing-section').classList.add('d-none');
                loadPublicProfile(code);
            }
        };

        // --- 2. Public View Logic ---
        window.manualSearch = () => {
            const code = document.getElementById('search-code').value.trim();
            if(code) loadPublicProfile(code);
        }

        async function loadPublicProfile(code) {
            try {
                const userSnap = await getDocs(query(collection(db, "users"), where("secretCode", "==", code.toUpperCase())));
                if(userSnap.empty) {
                    Swal.fire('ไม่พบข้อมูล', 'รหัสไม่ถูกต้อง', 'error').then(() => {
                         document.getElementById('landing-section').classList.remove('d-none');
                    });
                    return;
                }
                
                const userData = userSnap.docs[0].data();
                const targetUid = userSnap.docs[0].id;

                // Show Content
                document.getElementById('landing-section').classList.add('d-none');
                document.getElementById('view-section').classList.remove('d-none');
                
                document.getElementById('view-name').innerText = userData.email.split('@')[0];
                const annEl = document.getElementById('view-announcement');
                if(userData.publicMessage) {
                    annEl.classList.remove('d-none');
                    annEl.querySelector('span').innerText = userData.publicMessage;
                }

                // Load Accounts
                const bankSnap = await getDocs(query(collection(db, "bank_accounts"), where("userId", "==", targetUid)));
                const list = document.getElementById('view-list');
                list.innerHTML = '';
                
                let count = 0;
                bankSnap.forEach(doc => {
                    const data = doc.data();
                    if(data.isActive !== false) {
                        list.innerHTML += createBankCardHTML(data, false, null);
                        count++;
                    }
                });
                if(count === 0) list.innerHTML = '<div class="text-center text-muted p-4">ไม่พบบัญชีที่เปิดใช้งาน</div>';

            } catch(e) { console.error(e); }
        }

        // --- 3. HTML Generators (Beautiful Icons) ---
        function createBankCardHTML(data, isOwner, docId) {
            // Mapping Bank Name to CSS Classes & Icons
            const b = data.bankName;
            let theme = { bg: 'promptpay-bg', icon: 'pf-promptpay' };
            
            if(b.includes('กสิกร')) theme = { bg: 'kbank-bg', icon: 'pf-kbank' };
            else if(b.includes('ไทยพาณิชย์')) theme = { bg: 'scb-bg', icon: 'pf-scb' };
            else if(b.includes('กรุงไทย')) theme = { bg: 'ktb-bg', icon: 'pf-krungthai' };
            else if(b.includes('กรุงเทพ')) theme = { bg: 'bbl-bg', icon: 'pf-bbl' };
            else if(b.includes('ออมสิน')) theme = { bg: 'gsb-bg', icon: 'pf-gsb' };
            else if(b.includes('ทหารไทย')) theme = { bg: 'ttb-bg', icon: 'pf-ttb' };
            else if(b.includes('True')) theme = { bg: 'truemoney-bg', icon: 'pf-wallet' };

            const controls = isOwner ? 
                `<button class="btn btn-sm btn-dark bg-opacity-50 text-danger border-0" onclick="delAcc('${docId}')"><i class="fas fa-trash"></i></button>` : 
                `<button class="copy-btn" onclick="copy('${data.accountNumber}')"><i class="far fa-copy"></i> Copy</button>`;

            return `
            <div class="bank-card ${theme.bg}">
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <div class="d-flex align-items-center gap-3">
                        <div class="bank-logo"><i class="pf ${theme.icon} text-dark"></i></div>
                        <div>
                            <h5 class="m-0 fw-bold text-white text-shadow">${data.bankName}</h5>
                            <small class="text-white opacity-75">${data.accountName}</small>
                        </div>
                    </div>
                </div>
                <div class="d-flex align-items-end justify-content-between mt-3">
                    <div class="acc-number text-white">${formatAcc(data.accountNumber)}</div>
                    ${controls}
                </div>
            </div>`;
        }

        const formatAcc = (n) => n.replace(/(\d{3})(\d{1,})(\d{4})/, "$1-$2-$3");

        // --- 4. Admin/Owner Logic ---
        window.showLogin = () => document.getElementById('auth-modal').classList.remove('d-none');
        window.closeLogin = () => document.getElementById('auth-modal').classList.add('d-none');
        
        window.doLogin = async () => {
            const e = document.getElementById('login-email').value, p = document.getElementById('login-pass').value;
            try { await signInWithEmailAndPassword(auth, e, p); closeLogin(); }
            catch { try {
                const cred = await createUserWithEmailAndPassword(auth, e, p);
                const code = generateSecretCode();
                await setDoc(doc(db, "users", cred.user.uid), { email: e, secretCode: code, createdAt: new Date() });
                closeLogin();
            } catch(err){ Swal.fire('Error', err.message, 'error'); }}
        };
        const generateSecretCode = () => { const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; let r=''; for(let i=0;i<6;i++)r+=c.charAt(Math.floor(Math.random()*c.length)); return r; };

        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            const adminSec = document.getElementById('admin-section');
            const landingSec = document.getElementById('landing-section');
            const viewSec = document.getElementById('view-section');

            if (user) {
                // ถ้า Login -> แสดงหน้า Admin
                adminSec.classList.remove('d-none');
                landingSec.classList.add('d-none');
                viewSec.classList.add('d-none'); // ซ่อนหน้า view ปกติ
                
                // Load Info
                const docSnap = await getDoc(doc(db, "users", user.uid));
                if(docSnap.exists()){
                    const d = docSnap.data();
                    document.getElementById('my-secret-code').innerText = d.secretCode;
                    document.getElementById('my-msg').value = d.publicMessage || '';
                    
                    // สร้าง Link
                    const fullLink = `${window.location.origin}${window.location.pathname}?code=${d.secretCode}`;
                    document.getElementById('share-link-input').value = fullLink;
                }
                loadMyAccs();
            } else {
                // ถ้าไม่ Login -> ให้ดูว่ามี code ใน url ไหม ถ้าไม่มีกลับหน้า Landing
                adminSec.classList.add('d-none');
                const urlParams = new URLSearchParams(window.location.search);
                if(!urlParams.get('code')) landingSec.classList.remove('d-none');
            }
        });

        // CRUD
        function loadMyAccs() {
            onSnapshot(query(collection(db, "bank_accounts"), where("userId", "==", currentUser.uid)), (snap) => {
                const list = document.getElementById('my-account-list'); list.innerHTML = '';
                snap.forEach(d => list.innerHTML += createBankCardHTML(d.data(), true, d.id));
            });
        }
        window.saveMsg = async () => { await updateDoc(doc(db, "users", currentUser.uid), { publicMessage: document.getElementById('my-msg').value }); Swal.fire('Saved', '', 'success'); };
        window.openAddModal = async () => {
             const { value: v } = await Swal.fire({
                title: 'เพิ่มบัญชี', html: `
                <select id="swal-b" class="form-select mb-2"><option>กสิกรไทย</option><option>ไทยพาณิชย์</option><option>กรุงไทย</option><option>กรุงเทพ</option><option>ออมสิน</option><option>ทหารไทยธนชาต (ttb)</option><option>พร้อมเพย์</option><option>TrueMoney</option></select>
                <input id="swal-n" class="form-control mb-2" placeholder="เลขบัญชี"><input id="swal-nm" class="form-control" placeholder="ชื่อบัญชี">`,
                showCancelButton: true, preConfirm: () => [document.getElementById('swal-b').value, document.getElementById('swal-n').value, document.getElementById('swal-nm').value]
            });
            if(v) await addDoc(collection(db, "bank_accounts"), { userId: currentUser.uid, bankName: v[0], accountNumber: v[1], accountName: v[2], isActive: true });
        };
        window.delAcc = async(id) => { if((await Swal.fire({title:'ลบ?',icon:'warning',showCancelButton:true})).isConfirmed) deleteDoc(doc(db,"bank_accounts",id)); };
        
        // Utils
        window.copy = (t) => { navigator.clipboard.writeText(t); Swal.fire({icon:'success',title:'Copied',toast:true,position:'top',timer:800,showConfirmButton:false}); };
        window.copyShareLink = () => window.copy(document.getElementById('share-link-input').value);

    </script>
</body>
</html>
