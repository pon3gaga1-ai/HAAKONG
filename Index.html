<!DOCTYPE html>
<html lang="th" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PayLink Auto System</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lazywasabi/thai-bank-icons@master/dist/css/thai-bank-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --bg-deep: #0f172a;
            --glass: rgba(30, 41, 59, 0.7);
            --primary: #6366f1;
            --accent: #10b981;
        }

        body {
            font-family: 'Prompt', sans-serif;
            background-color: var(--bg-deep);
            background-image: radial-gradient(at top center, #1e293b 0%, #0f172a 100%);
            color: #f8fafc;
            min-height: 100vh;
        }

        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }

        /* ปุ่มจัดการสวยๆ */
        .action-btn {
            border: none; padding: 8px 15px; border-radius: 8px; font-size: 0.9rem; transition: 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 5px; width: 100%;
        }
        .btn-bank { background: rgba(99, 102, 241, 0.15); color: #818cf8; }
        .btn-bank:hover { background: #6366f1; color: white; }
        
        .btn-ext { background: rgba(16, 185, 129, 0.15); color: #34d399; }
        .btn-ext:hover { background: #10b981; color: white; }

        .btn-del { background: rgba(239, 68, 68, 0.15); color: #f87171; }
        .btn-del:hover { background: #ef4444; color: white; }

        /* การ์ดลูกค้า */
        .client-card {
            transition: transform 0.2s; border-left: 4px solid transparent;
        }
        .client-card:hover { transform: translateY(-3px); background: rgba(255,255,255,0.05); }
        .client-card.active { border-left-color: #10b981; }
        .client-card.expired { border-left-color: #ef4444; opacity: 0.7; }

        /* เลือกธนาคารแบบเรียบง่าย */
        .bank-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .bank-opt {
            cursor: pointer; padding: 10px; border-radius: 10px; text-align: center;
            background: rgba(0,0,0,0.2); border: 2px solid transparent; transition: 0.2s;
        }
        .bank-opt:hover { background: rgba(255,255,255,0.1); }
        .bank-opt.selected { border-color: var(--primary); background: rgba(99, 102, 241, 0.2); }
        .bank-opt i { font-size: 24px; margin-bottom: 5px; display: block; }
        .bank-opt span { font-size: 10px; display: block; }

        /* ซ่อนปุ่ม Login */
        .secret-trigger { position: fixed; bottom: 0; right: 0; padding: 20px; opacity: 0; cursor: default; }
    </style>
</head>
<body>

    <div id="client-view" class="d-none container py-5" style="max-width: 500px;">
        <div class="glass-panel p-4 text-center">
            <div id="status-alert" class="alert alert-danger d-none border-0 bg-danger bg-opacity-25 text-white mb-4">
                <i class="fas fa-lock me-2"></i> บัญชีหมดอายุ
            </div>

            <div class="mb-4">
                <i class="fas fa-wallet fa-3x text-primary mb-3"></i>
                <h2 id="view-name" class="fw-bold mb-1">...</h2>
                <small class="text-white-50">Secure Payment</small>
            </div>

            <div id="view-bank-list" class="text-start"></div>

            <div class="mt-5 pt-3 border-top border-secondary border-opacity-25">
                <a id="fb-link" href="#" target="_blank" class="btn btn-outline-light w-100 rounded-pill">
                    <i class="fab fa-facebook-messenger me-2"></i> ติดต่อแอดมิน
                </a>
            </div>
        </div>
        <div class="secret-trigger" onclick="secretLogin()">v.auto</div>
    </div>

    <div id="admin-view" class="d-none container py-4" style="max-width: 900px;">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="fw-bold m-0"><span class="text-primary">Pay</span>Link <small class="fs-6 text-white-50">Manager</small></h4>
            <button onclick="logout()" class="btn btn-sm btn-dark text-danger border-secondary">Logout</button>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-md-7">
                <div class="glass-panel p-3 h-100">
                    <label class="small text-white-50 mb-2"><i class="fas fa-user-plus me-1"></i> สร้างลูกค้าใหม่ (รหัสอัตโนมัติ)</label>
                    <div class="d-flex gap-2">
                        <input id="new-name" class="form-control bg-dark text-white border-secondary" placeholder="ระบุชื่อลูกค้า...">
                        <input type="number" id="new-days" class="form-control bg-dark text-white border-secondary" placeholder="วัน (30)" style="width: 80px;" value="30">
                        <button onclick="createClient()" class="btn btn-primary px-3"><i class="fas fa-magic"></i></button>
                    </div>
                </div>
            </div>
            <div class="col-md-5">
                <div class="glass-panel p-3 h-100">
                    <label class="small text-white-50 mb-2"><i class="fab fa-facebook me-1"></i> ลิงก์ติดต่อ</label>
                    <div class="input-group">
                        <input id="set-fb" class="form-control bg-dark text-white border-secondary form-control-sm" placeholder="https://m.me/...">
                        <button onclick="saveConf()" class="btn btn-outline-light btn-sm"><i class="fas fa-save"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-3 position-relative">
            <i class="fas fa-search position-absolute text-white-50" style="top:12px; left:15px;"></i>
            <input type="text" id="search-box" onkeyup="filterList()" class="form-control bg-dark text-white border-secondary ps-5 rounded-pill" placeholder="พิมพ์ชื่อลูกค้าเพื่อค้นหา...">
        </div>

        <div id="client-list" class="row g-3"></div>
    </div>

    <div class="modal fade" id="bankModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content glass-panel bg-dark">
                <div class="modal-header border-bottom border-secondary border-opacity-25">
                    <h5 class="modal-title">จัดการบัญชี: <span id="m-name" class="text-primary"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="bank-selector" class="bank-grid mb-3"></div>
                    <input type="hidden" id="sel-bank">
                    
                    <div class="input-group mb-4">
                        <input id="m-acc" class="form-control bg-dark text-white border-secondary" placeholder="เลขบัญชี">
                        <button onclick="addBank()" class="btn btn-success"><i class="fas fa-plus"></i></button>
                    </div>

                    <div class="d-flex align-items-center mb-2">
                        <hr class="flex-grow-1 border-secondary border-opacity-25">
                        <span class="px-2 small text-white-50">รายการบัญชี</span>
                        <hr class="flex-grow-1 border-secondary border-opacity-25">
                    </div>
                    
                    <div id="m-list" style="max-height: 250px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, deleteDoc, updateDoc, doc, setDoc, onSnapshot, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDT39HkTA1TLFKvuQNZcrNeIZMLANgy2z0",
            authDomain: "scan-4b703.firebaseapp.com",
            projectId: "scan-4b703",
            storageBucket: "scan-4b703.firebasestorage.app",
            messagingSenderId: "667992011250",
            appId: "1:667992011250:web:adce534c0f97b4ddb47b6b"
        };
        const ADMIN_EMAIL = "fafa@gmail.com";
        const BANKS = [
            {c:'kbank',n:'กสิกร',i:'pf-kbank',cl:'#00cc6a'},{c:'scb',n:'ไทยพาณิชย์',i:'pf-scb',cl:'#4e2e7f'},
            {c:'ktb',n:'กรุงไทย',i:'pf-krungthai',cl:'#00a5e5'},{c:'bbl',n:'กรุงเทพ',i:'pf-bbl',cl:'#1e4598'},
            {c:'gsb',n:'ออมสิน',i:'pf-gsb',cl:'#eb198d'},{c:'truemoney',n:'Wallet',i:'pf-wallet',cl:'#ff5c00'},
            {c:'promptpay',n:'พร้อมเพย์',i:'pf-promptpay',cl:'#1c3d6e'},{c:'ttb',n:'ทีทีบี',i:'pf-ttb',cl:'#0050f0'}
        ];

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let editingId = null;
        let clickCount = 0;

        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            const admin = params.get('admin');

            renderSelector();

            if(admin === 'login') triggerLogin();
            else if(code) loadPublic(code);
        };

        // --- AUTH ---
        window.secretLogin = () => { if(++clickCount >= 5) { clickCount=0; triggerLogin(); } };
        async function triggerLogin() {
            const {value:v} = await Swal.fire({
                title:'Admin Login', html:'<input id="e" class="swal2-input" placeholder="Email"><input id="p" type="password" class="swal2-input" placeholder="Pass">',
                focusConfirm:false, background:'#1e293b', color:'#fff', preConfirm:()=>[document.getElementById('e').value,document.getElementById('p').value]
            });
            if(v) {
                try { await signInWithEmailAndPassword(auth,v[0],v[1]); } catch(e){ Swal.fire('Error',e.message,'error'); }
            }
        }
        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, u => {
            if(u && u.email===ADMIN_EMAIL) {
                document.getElementById('admin-view').classList.remove('d-none');
                document.getElementById('client-view').classList.add('d-none');
                initAdmin();
            } else {
                document.getElementById('admin-view').classList.add('d-none');
            }
        });

        // --- ADMIN ---
        function initAdmin() {
            getDoc(doc(db,"system_config","main")).then(d=>{ if(d.exists()) document.getElementById('set-fb').value = d.data().fbLink||''; });

            onSnapshot(query(collection(db,"clients"), orderBy("createdAt","desc")), snap => {
                const el = document.getElementById('client-list'); el.innerHTML='';
                snap.forEach(d => {
                    const data = d.data();
                    const left = Math.ceil((data.expireAt - Date.now())/86400000);
                    const isExp = left <= 0;
                    
                    el.innerHTML += `
                    <div class="col-md-6 client-item">
                        <div class="glass-panel p-3 client-card ${isExp?'expired':'active'}">
                            <div class="d-flex justify-content-between mb-2">
                                <h5 class="fw-bold m-0">${data.name}</h5>
                                <span class="badge ${isExp?'bg-danger':'bg-success'} rounded-pill">${isExp?'Expired':left+' วัน'}</span>
                            </div>
                            <div class="bg-black bg-opacity-25 rounded p-2 mb-3 d-flex justify-content-between align-items-center">
                                <span class="font-monospace text-info">${data.code}</span>
                                <button class="btn btn-sm btn-link text-white-50 p-0" onclick="copy('${window.location.origin}?code=${data.code}')"><i class="far fa-copy"></i> Link</button>
                            </div>
                            <div class="row g-2">
                                <div class="col-4"><button onclick="openModal('${d.id}','${data.name}')" class="action-btn btn-bank"><i class="fas fa-wallet"></i> บัญชี</button></div>
                                <div class="col-4"><button onclick="extend('${d.id}')" class="action-btn btn-ext"><i class="fas fa-plus"></i> วัน</button></div>
                                <div class="col-4"><button onclick="del('${d.id}')" class="action-btn btn-del"><i class="fas fa-trash"></i> ลบ</button></div>
                            </div>
                        </div>
                    </div>`;
                });
            });
        }

        window.createClient = async () => {
            const name = document.getElementById('new-name').value;
            if(!name) return Swal.fire('ใส่ชื่อลูกค้า','','warning');
            
            // Auto Code Gen
            const code = 'PAY-' + Math.random().toString(36).substring(2,6).toUpperCase();
            const days = parseInt(document.getElementById('new-days').value) || 30;
            const exp = new Date(); exp.setDate(exp.getDate()+days);

            await addDoc(collection(db,"clients"), { name, code, expireAt: exp.getTime(), createdAt: Date.now() });
            Swal.fire({icon:'success', title:'สร้างสำเร็จ', text:`Code: ${code}`, background:'#1e293b', color:'#fff'});
            document.getElementById('new-name').value = '';
        }

        window.filterList = () => {
            const term = document.getElementById('search-box').value.toLowerCase();
            document.querySelectorAll('.client-item').forEach(el => {
                el.style.display = el.innerText.toLowerCase().includes(term) ? 'block' : 'none';
            });
        }
        window.saveConf = async () => {
            await setDoc(doc(db,"system_config","main"), {fbLink: document.getElementById('set-fb').value});
            Swal.fire({toast:true, icon:'success', title:'Saved', position:'top-end', showConfirmButton:false, timer:1500});
        }
        window.del = async(id) => { if((await Swal.fire({title:'ยืนยันลบ?',icon:'warning',showCancelButton:true})).isConfirmed) deleteDoc(doc(db,"clients",id)); }
        window.extend = async(id) => {
            const {value} = await Swal.fire({title:'เพิ่มวัน',input:'number',inputValue:30});
            if(value) {
                const d = new Date(); d.setDate(d.getDate()+parseInt(value));
                updateDoc(doc(db,"clients",id), {expireAt: d.getTime()});
            }
        }

        // --- BANK MODAL ---
        function renderSelector() {
            const el = document.getElementById('bank-selector'); el.innerHTML='';
            BANKS.forEach(b => {
                el.innerHTML += `<div class="bank-opt" onclick="selBank('${b.c}',this)"><i class="pf ${b.i}" style="color:${b.cl}"></i><span>${b.n}</span></div>`;
            });
        }
        window.selBank = (c,el) => {
            document.querySelectorAll('.bank-opt').forEach(e=>e.classList.remove('selected'));
            el.classList.add('selected'); document.getElementById('sel-bank').value=c;
        }
        
        // Modal Logic Fix
        let bsModal = null;
        window.openModal = (id, name) => {
            editingId = id;
            document.getElementById('m-name').innerText = name;
            loadBanks(id, true);
            const modalEl = document.getElementById('bankModal');
            bsModal = new bootstrap.Modal(modalEl);
            bsModal.show();
        }

        function loadBanks(cid, isAdmin) {
            const target = isAdmin ? 'm-list' : 'view-bank-list';
            onSnapshot(query(collection(db,"bank_accounts"), where("clientId","==",cid)), snap => {
                const el = document.getElementById(target); el.innerHTML='';
                if(snap.empty) { el.innerHTML='<p class="text-center text-white-50 py-3">ไม่มีข้อมูล</p>'; return;}
                
                snap.forEach(d => {
                    const b = d.data();
                    const i = BANKS.find(x=>x.c===b.bank) || BANKS[0];
                    const acc = b.accNum;
                    
                    if(isAdmin) {
                        el.innerHTML += `<div class="d-flex justify-content-between align-items-center p-2 mb-2 bg-white bg-opacity-10 rounded"><div class="d-flex align-items-center"><i class="pf ${i.i} fs-4 me-2" style="color:${i.cl}"></i><span>${acc}</span></div><button onclick="delBank('${d.id}')" class="btn btn-sm btn-danger py-0"><i class="fas fa-times"></i></button></div>`;
                    } else {
                        el.innerHTML += `<div class="glass-panel p-3 mb-2 d-flex align-items-center justify-content-between cursor-pointer" onclick="copy('${acc}')"><div class="d-flex align-items-center"><div class="bg-white rounded p-1 me-3"><i class="pf ${i.i} fs-2" style="color:${i.cl}"></i></div><div><div class="small text-white-50">${i.n}</div><div class="fs-5 fw-bold font-monospace">${acc}</div></div></div><button class="btn btn-sm btn-light rounded-pill">Copy</button></div>`;
                    }
                });
            }); // <-- ถ้าตรงนี้ error ใน console แปลว่า index หาย
        }

        window.addBank = async () => {
            const bank = document.getElementById('sel-bank').value;
            const acc = document.getElementById('m-acc').value;
            if(!bank || !acc) return;
            await addDoc(collection(db,"bank_accounts"), {clientId: editingId, bank, accNum: acc});
            document.getElementById('m-acc').value='';
        }
        window.delBank = (id) => deleteDoc(doc(db,"bank_accounts",id));

        // --- PUBLIC ---
        async function loadPublic(code) {
            const snap = await getDocs(query(collection(db,"clients"), where("code","==",code)));
            if(snap.empty) return Swal.fire('Error','Code Invalid','error');
            const data = snap.docs[0].data();
            document.getElementById('client-view').classList.remove('d-none');
            document.getElementById('view-name').innerText = data.name;
            
            getDoc(doc(db,"system_config","main")).then(d=>{ if(d.exists()) document.getElementById('fb-link').href=d.data().fbLink||'#'; });

            if(Date.now() > data.expireAt) {
                document.getElementById('status-alert').classList.remove('d-none');
            } else {
                loadBanks(snap.docs[0].id, false);
            }
        }

        window.copy = (t) => { navigator.clipboard.writeText(t); Swal.fire({toast:true,icon:'success',title:'Copied',position:'top',showConfirmButton:false,timer:1000}); }
    </script>
</body>
</html>
