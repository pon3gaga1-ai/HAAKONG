<!DOCTYPE html>
<html lang="th" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MoneyLink Pro - นามบัตรการเงินสุดล้ำ</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #1d4ed8;
            --accent: #8b5cf6;
            --bg-dark: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text-light: #e2e8f0;
        }

        body {
            font-family: 'Prompt', sans-serif;
            background: radial-gradient(circle at top right, #1e293b, var(--bg-dark));
            min-height: 100vh;
            color: var(--text-light);
        }

        /* --- Premium UI Elements --- */
        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .btn-gradient {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border: none; color: white; font-weight: 600;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
            transition: all 0.3s;
        }
        .btn-gradient:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(59, 130, 246, 0.5); color: white; }
        .btn-gradient:active { transform: scale(0.98); }

        .form-control, .form-select {
            background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-light); border-radius: 12px; padding: 12px;
        }
        .form-control:focus { background: rgba(255, 255, 255, 0.1); border-color: var(--primary); box-shadow: none; color: white; }

        /* --- Specific Components --- */
        .auth-box { max-width: 420px; margin: 8vh auto; padding: 40px; }
        .main-box { max-width: 900px; margin: 30px auto; padding: 20px; }

        .secret-code-badge {
            background: linear-gradient(45deg, #2563eb, #7c3aed);
            padding: 20px; border-radius: 20px; text-align: center;
            position: relative; overflow: hidden;
        }
        .secret-code-badge::after {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: linear-gradient(transparent, rgba(255,255,255,0.2), transparent);
            transform: rotate(45deg); animation: shine 3s infinite;
        }
        @keyframes shine { 0% {top:-150%; left:-150%;} 100% {top:150%; left:150%;} }
        .code-text { font-size: 3rem; font-weight: 800; letter-spacing: 4px; font-family: monospace; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }

        /* --- Bank Cards (Redesigned) --- */
        .bank-card {
            position: relative;
            background: linear-gradient(135deg, #334155, #1e293b);
            border-radius: 20px; padding: 25px; margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.05);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            overflow: hidden; transition: all 0.3s;
        }
        .bank-card.disabled { opacity: 0.5; filter: grayscale(0.8); }
        .bank-card::before {
            content: ''; position: absolute; top: -50px; right: -50px; width: 150px; height: 150px;
            background: currentColor; opacity: 0.1; border-radius: 50%; filter: blur(40px);
        }
        
        /* Bank Themes */
        .kbank { color: #00cc6a; } .kbank-bg { background: linear-gradient(135deg, #005c30, #00361c); }
        .scb { color: #4e2e7f; } .scb-bg { background: linear-gradient(135deg, #4e2e7f, #2c1a4a); }
        .ktb { color: #00a5e5; } .ktb-bg { background: linear-gradient(135deg, #008bc2, #005f85); }
        .bbl { color: #1e4598; } .bbl-bg { background: linear-gradient(135deg, #1e4598, #122a5c); }
        .promptpay { color: #0f3d6b; } .promptpay-bg { background: linear-gradient(135deg, #1e3a8a, #172554); }
        .truemoney { color: #ff5c00; } .truemoney-bg { background: linear-gradient(135deg, #c2410c, #7c2d12); }

        .acc-num { font-size: 1.8rem; font-weight: 700; letter-spacing: 1px; font-family: monospace; margin: 10px 0; }
        .copy-btn { background: rgba(255,255,255,0.1); border: none; color: white; padding: 8px 15px; border-radius: 30px; font-size: 0.9rem; transition: 0.2s; }
        .copy-btn:hover { background: var(--primary); }

        /* Announcement Box */
        .announcement-box {
            background: rgba(245, 158, 11, 0.15); border-left: 4px solid #f59e0b;
            padding: 15px; border-radius: 12px; color: #fbbf24; margin-bottom: 25px;
             animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.2); } 70% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); } 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); } }

        /* Tabs & Toggles */
        .nav-pills .nav-link { color: #94a3b8; border-radius: 50px; padding: 12px 25px; font-weight: 600; transition: 0.3s; }
        .nav-pills .nav-link.active { background: var(--primary); color: white; box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4); }
        .form-switch .form-check-input { width: 3em; height: 1.5em; cursor: pointer; }
        .form-switch .form-check-input:checked { background-color: var(--primary); border-color: var(--primary); }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark bg-transparent py-3">
        <div class="container">
            <a class="navbar-brand fw-bold fs-3" href="#"><i class="fas fa-bolt text-primary me-2"></i>MoneyLink<span class="text-accent">Pro</span></a>
            <button onclick="logout()" id="logout-btn" class="btn btn-sm btn-outline-danger rounded-pill px-3 d-none"><i class="fas fa-power-off"></i></button>
        </div>
    </nav>

    <div id="auth-section" class="container">
        <div class="glass-card auth-box text-center">
            <h3 class="fw-bold mb-4 bg-gradient p-1 rounded"><i class="fas fa-rocket me-2"></i>เข้าสู่ระบบ</h3>
            <div class="form-floating mb-3">
                <input type="email" class="form-control" id="email" placeholder="Email">
                <label class="text-muted">อีเมล</label>
            </div>
            <div class="form-floating mb-4">
                <input type="password" class="form-control" id="password" placeholder="Password">
                <label class="text-muted">รหัสผ่าน</label>
            </div>
            <button onclick="authAction()" class="btn btn-gradient w-100 py-3 rounded-pill fs-5">Login / Register</button>
        </div>
    </div>

    <div id="app-section" class="container d-none">
        <div class="main-box">
            
            <ul class="nav nav-pills nav-fill mb-5 p-1 glass-card rounded-pill mx-auto" style="max-width: 450px;">
                <li class="nav-item"><button class="nav-link active" onclick="switchTab('search')"><i class="fas fa-search me-2"></i>ค้นหา</button></li>
                <li class="nav-item"><button class="nav-link" onclick="switchTab('manage')"><i class="fas fa-wallet me-2"></i>กระเป๋าของฉัน</button></li>
            </ul>

            <div id="tab-search">
                <div class="text-center mb-5">
                    <h1 class="fw-bold display-5 mb-3">จ่ายให้ใคร?</h1>
                    <p class="text-muted fs-5">กรอกรหัสลับ 6 หลัก เพื่อดูบัญชีปลายทาง</p>
                    <div class="input-group glass-card rounded-pill overflow-hidden mt-4 mx-auto" style="max-width: 500px; padding: 5px;">
                        <input type="text" id="search-code" class="form-control border-0 ps-4 fs-4 fw-bold text-center" placeholder="X9A2B1" style="letter-spacing: 3px; text-transform: uppercase; background: transparent;">
                        <button class="btn btn-gradient px-4 rounded-pill m-1" onclick="searchProfile()"><i class="fas fa-search fa-lg"></i></button>
                    </div>
                </div>

                <div id="search-result" class="d-none fade-in">
                    <div class="d-flex align-items-center mb-4">
                        <div class="bg-primary rounded-circle p-3 me-3"><i class="fas fa-user fs-3"></i></div>
                        <div>
                            <small class="text-muted d-block">บัญชีของ</small>
                            <h3 class="fw-bold m-0" id="result-owner-name">...</h3>
                        </div>
                    </div>
                    <div id="public-announcement" class="d-none"></div>

                    <div id="result-list"></div>
                </div>
            </div>

            <div id="tab-manage" class="d-none">
                <div class="glass-card p-4 mb-4">
                    <div class="row align-items-center">
                        <div class="col-md-6 text-center mb-4 mb-md-0">
                            <small class="text-uppercase text-muted fw-bold ls-2">รหัสลับของคุณ</small>
                            <div class="secret-code-badge mt-2 mx-auto" style="max-width: 300px;">
                                <span id="my-secret-code" class="code-text">------</span>
                            </div>
                            <button class="btn btn-sm btn-outline-light rounded-pill mt-3 px-3" onclick="copyCode()"><i class="far fa-copy me-2"></i>คัดลอก</button>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-accent"><i class="fas fa-bullhorn me-2"></i>ประกาศหน้าบัญชี (Public Message)</label>
                            <div class="input-group">
                                <textarea id="my-announcement" class="form-control" rows="3" placeholder="เช่น: ช่วงนี้งดรับ TrueMoney, อยู่ ตปท. ตอบช้า"></textarea>
                                <button class="btn btn-outline-primary" onclick="saveAnnouncement()"><i class="fas fa-save"></i></button>
                            </div>
                            <small class="text-muted">*ข้อความนี้จะแสดงให้คนที่มาค้นหาคุณเห็น</small>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-4 px-2">
                    <h4 class="fw-bold m-0"><i class="fas fa-list-ul me-2 text-primary"></i>บัญชีทั้งหมด</h4>
                    <button class="btn btn-gradient rounded-pill px-4" onclick="openAddModal()"><i class="fas fa-plus me-2"></i>เพิ่มบัญชี</button>
                </div>

                <div id="my-account-list"></div>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, deleteDoc, updateDoc, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDT39HkTA1TLFKvuQNZcrNeIZMLANgy2z0",
            authDomain: "scan-4b703.firebaseapp.com",
            projectId: "scan-4b703",
            storageBucket: "scan-4b703.firebasestorage.app",
            messagingSenderId: "667992011250",
            appId: "1:667992011250:web:adce534c0f97b4ddb47b6b",
            measurementId: "G-X5QG9YZWG6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;

        // --- Auth & Init ---
        window.authAction = async () => {
            const e = document.getElementById('email').value, p = document.getElementById('password').value;
            if(!e || !p) return Swal.fire('แจ้งเตือน','กรอกให้ครบ','warning');
            try { await signInWithEmailAndPassword(auth, e, p); } catch {
                try {
                    const cred = await createUserWithEmailAndPassword(auth, e, p);
                    const code = generateSecretCode();
                    await setDoc(doc(db, "users", cred.user.uid), { email: e, secretCode: code, publicMessage: "", createdAt: new Date() });
                    Swal.fire("สำเร็จ", `รหัสลับของคุณคือ ${code}`, "success");
                } catch (err) { Swal.fire("Error", err.message, "error"); }
            }
        };
        const generateSecretCode = () => { const c = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; let r = ''; for(let i=0;i<6;i++) r += c.charAt(Math.floor(Math.random()*c.length)); return r; };
        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                document.getElementById('auth-section').classList.add('d-none');
                document.getElementById('app-section').classList.remove('d-none');
                document.getElementById('logout-btn').classList.remove('d-none');
                loadMyProfile();
                loadMyAccounts();
                switchTab('manage');
            } else {
                document.getElementById('auth-section').classList.remove('d-none');
                document.getElementById('app-section').classList.add('d-none');
                document.getElementById('logout-btn').classList.add('d-none');
            }
        });

        // --- Manage Tab (Owner) ---
        async function loadMyProfile() {
            const docSnap = await getDoc(doc(db, "users", currentUser.uid));
            if(docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('my-secret-code').innerText = data.secretCode;
                document.getElementById('my-announcement').value = data.publicMessage || "";
            }
        }

        window.saveAnnouncement = async () => {
            const msg = document.getElementById('my-announcement').value;
            await updateDoc(doc(db, "users", currentUser.uid), { publicMessage: msg });
            Swal.fire({ icon: 'success', title: 'บันทึกประกาศแล้ว', toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 });
        };

        function loadMyAccounts() {
            const q = query(collection(db, "bank_accounts"), where("userId", "==", currentUser.uid));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('my-account-list'); list.innerHTML = '';
                if(snapshot.empty) return list.innerHTML = '<div class="text-center text-muted py-5 opacity-50"><i class="fas fa-wallet fa-3x mb-3"></i><p>ยังไม่มีบัญชี เพิ่มเลย!</p></div>';
                snapshot.forEach(doc => list.innerHTML += createBankCardHTML(doc.data(), true, doc.id));
            });
        }

        window.toggleAccount = async (id, currentStatus) => {
            // ถ้า currentStatus คือ undefined หรือ null ให้ถือว่าเป็น true (active)
            const newStatus = !(currentStatus !== false); 
            await updateDoc(doc(db, "bank_accounts", id), { isActive: newStatus });
        };

        // --- Search Tab (Public) ---
        window.searchProfile = async () => {
            const code = document.getElementById('search-code').value.toUpperCase().trim();
            if(!code) return;
            const userSnap = await getDocs(query(collection(db, "users"), where("secretCode", "==", code)));
            if(userSnap.empty) return Swal.fire('ไม่พบผู้ใช้', 'รหัสลับไม่ถูกต้อง', 'error');

            const targetUser = userSnap.docs[0].data();
            const targetUid = userSnap.docs[0].id;
            document.getElementById('result-owner-name').innerText = targetUser.email.split('@')[0];

            const annBox = document.getElementById('public-announcement');
            if(targetUser.publicMessage) {
                annBox.innerHTML = `<i class="fas fa-bullhorn me-2"></i><b>แจ้งเตือน:</b> ${targetUser.publicMessage}`;
                annBox.className = 'announcement-box d-block';
            } else { annBox.className = 'd-none'; }

            // ค้นหาเฉพาะบัญชีที่ isActive == true (หรือไม่มี field isActive)
            const bankSnap = await getDocs(query(collection(db, "bank_accounts"), where("userId", "==", targetUid)));
            const resultList = document.getElementById('result-list'); resultList.innerHTML = '';
            
            let activeCount = 0;
            bankSnap.forEach(doc => {
                const data = doc.data();
                // กรองเฉพาะที่เปิดใช้งาน (เผื่อ query เก่า)
                if(data.isActive !== false) {
                     resultList.innerHTML += createBankCardHTML(data, false, null);
                     activeCount++;
                }
            });
            if(activeCount === 0) resultList.innerHTML = '<p class="text-center text-muted mt-4">ผู้ใช้นี้ปิดบัญชีทั้งหมดชั่วคราว</p>';

            document.getElementById('search-result').classList.remove('d-none');
            document.getElementById('search-result').scrollIntoView({ behavior: 'smooth' });
        };

        // --- Helpers ---
        function createBankCardHTML(data, isOwner, docId) {
            const banks = {
                'กสิกรไทย': {c:'kbank', i:'kbank'}, 'ไทยพาณิชย์': {c:'scb', i:'scb'}, 'กรุงไทย': {c:'ktb', i:'krungthai'},
                'กรุงเทพ': {c:'bbl', i:'bbl'}, 'พร้อมเพย์': {c:'promptpay', i:'promptpay'}, 'TrueMoney': {c:'truemoney', i:'wallet'}
            };
            const theme = banks[data.bankName] || {c:'promptpay', i:'university'};
            const isDisabled = isOwner && data.isActive === false ? 'disabled' : '';
            const activeState = data.isActive !== false; // true ถ้าไม่มี field หรือเป็น true

            let controls = '';
            if(isOwner) {
                controls = `
                <div class="d-flex align-items-center gap-3">
                    <div class="form-check form-switch m-0">
                        <input class="form-check-input shadow-sm" type="checkbox" role="switch" ${activeState ? 'checked' : ''} onchange="toggleAccount('${docId}', ${data.isActive})">
                        <label class="form-check-label small text-muted">${activeState ? 'เปิด' : 'ปิด'}</label>
                    </div>
                    <button class="btn btn-icon btn-sm text-danger opacity-50 hover-opacity-100" onclick="deleteAccount('${docId}')"><i class="fas fa-trash-alt"></i></button>
                </div>`;
            } else {
                 controls = `<button class="copy-btn px-3 py-2 fw-bold" onclick="copyText('${data.accountNumber}')"><i class="far fa-copy me-2"></i>คัดลอกเลข</button>`;
            }

            return `
            <div class="bank-card ${theme.c}-bg ${isDisabled}">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="d-flex align-items-center">
                        <i class="bank-icon pf pf-${theme.i} fs-2 me-3 text-white opacity-75"></i>
                        <h5 class="m-0 fw-bold text-white">${data.bankName}</h5>
                    </div>
                    ${isOwner ? '' : '<i class="fas fa-wifi opacity-50"></i>'}
                </div>
                <div class="acc-num text-white">${formatAccNum(data.accountNumber)}</div>
                <div class="d-flex justify-content-between align-items-end mt-3">
                    <div><small class="text-white opacity-75 d-block mb-1">ชื่อบัญชี</small><h6 class="m-0 text-white fw-bold">${data.accountName}</h6></div>
                    ${controls}
                </div>
            </div>`;
        }
        
        const formatAccNum = (num) => num.replace(/(\d{3})(\d{1,})(\d{4})/, "$1-$2-$3"); // จัด format เลขคร่าวๆ

        window.openAddModal = async () => {
            const { value: formValues } = await Swal.fire({
                title: 'เพิ่มบัญชีใหม่', customClass: { popup: 'glass-card bg-dark text-light' },
                html: `
                    <select id="swal-bank" class="form-select mb-3 bg-dark text-light border-secondary"><option value="กสิกรไทย">กสิกรไทย</option><option value="ไทยพาณิชย์">ไทยพาณิชย์</option><option value="กรุงไทย">กรุงไทย</option><option value="กรุงเทพ">กรุงเทพ</option><option value="พร้อมเพย์">พร้อมเพย์</option><option value="TrueMoney">TrueMoney Wallet</option></select>
                    <input id="swal-acc-num" class="form-control mb-2 bg-dark text-light border-secondary" placeholder="เลขบัญชี / เบอร์โทร">
                    <input id="swal-acc-name" class="form-control bg-dark text-light border-secondary" placeholder="ชื่อบัญชี">
                `,
                focusConfirm: false, showCancelButton: true, confirmButtonText: 'บันทึก', confirmButtonColor: '#3b82f6',
                preConfirm: () => [document.getElementById('swal-bank').value, document.getElementById('swal-acc-num').value, document.getElementById('swal-acc-name').value]
            });
            if (formValues && formValues[1]) {
                await addDoc(collection(db, "bank_accounts"), { userId: currentUser.uid, bankName: formValues[0], accountNumber: formValues[1], accountName: formValues[2], isActive: true, createdAt: new Date() });
                Swal.fire({icon: 'success', title: 'เพิ่มแล้ว', toast: true, position: 'top-end', showConfirmButton: false, timer: 1500});
            }
        };
        window.deleteAccount = async (id) => { if((await Swal.fire({title:'ลบไหม?',icon:'warning',showCancelButton:true,confirmButtonText:'ลบ',confirmButtonColor:'#ef4444', customClass:{popup:'glass-card bg-dark text-light'}})).isConfirmed) await deleteDoc(doc(db, "bank_accounts", id)); };
        window.copyText = (t) => { navigator.clipboard.writeText(t); Swal.fire({icon:'success',title:'คัดลอกแล้ว',toast:true,position:'top',showConfirmButton:false,timer:800}); };
        window.copyCode = () => window.copyText(document.getElementById('my-secret-code').innerText);
        window.switchTab = (t) => { document.querySelectorAll('[id^="tab-"]').forEach(e=>e.classList.add('d-none')); document.getElementById('tab-'+t).classList.remove('d-none'); document.querySelectorAll('.nav-link').forEach(e=>e.classList.remove('active')); event.currentTarget.classList.add('active'); if(t==='manage')document.querySelector('.nav-link:last-child').classList.add('active'); };
    </script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lazywasabi/thai-bank-icons@master/dist/css/thai-bank-icons.css">
</body>
</html>
