<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Time Attendance - ‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background-color: #f0f2f5; font-family: 'Sarabun', sans-serif; }
        
        .camera-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 0 auto;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            background: #000;
        }

        video {
            width: 100%;
            height: auto;
            display: block;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        .status-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
        }

        .log-box {
            height: 300px;
            overflow-y: auto;
            background: white;
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark bg-primary mb-4">
        <div class="container">
            <span class="navbar-brand mb-0 h1">ü§ñ AI Face Check-in</span>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <div class="col-md-7 mb-4">
                <div class="card border-0">
                    <div class="card-body p-0">
                        <div class="camera-container" id="camera-wrapper">
                            <span class="badge bg-warning text-dark status-badge" id="status-text">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•...</span>
                            <video id="video" autoplay muted></video>
                            </div>
                    </div>
                    <div class="card-footer bg-white d-flex justify-content-between p-3">
                        <input type="text" id="employee-name" class="form-control me-2" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô)">
                        <button class="btn btn-success text-nowrap" onclick="registerFace()" id="btn-register" disabled>
                            <i class="fas fa-user-plus"></i> ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
                        </button>
                    </div>
                    <small class="text-muted ms-3 mb-2">* ‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏Ñ‡πà‡∏°‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á</small>
                </div>
            </div>

            <div class="col-md-5">
                <h5 class="mb-3">üïí ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h5>
                <div class="log-box" id="log-container">
                    </div>
            </div>
        </div>
    </div>

    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, serverTimestamp, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- 1. Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyDT39HkTA1TLFKvuQNZcrNeIZMLANgy2z0",
            authDomain: "scan-4b703.firebaseapp.com",
            projectId: "scan-4b703",
            storageBucket: "scan-4b703.firebasestorage.app",
            messagingSenderId: "667992011250",
            appId: "1:667992011250:web:adce534c0f97b4ddb47b6b",
            measurementId: "G-X5QG9YZWG6"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- 2. Variables & Setup ---
        const video = document.getElementById('video');
        const wrapper = document.getElementById('camera-wrapper');
        const statusText = document.getElementById('status-text');
        const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models'; // Public Models
        let labeledFaceDescriptors = [];
        let faceMatcher;
        let canvas;
        let isModelLoaded = false;
        let lastCheckInTime = {}; // ‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£ check-in ‡∏£‡∏±‡∏ß‡πÜ

        // --- 3. Load AI Models & Webcam ---
        Promise.all([
            faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
            faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
            faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
        ]).then(startVideo).catch(err => {
            console.error(err);
            statusText.innerText = "‚ùå ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏ô‡πá‡∏ï)";
            statusText.className = "badge bg-danger status-badge";
        });

        function startVideo() {
            navigator.mediaDevices.getUserMedia({ video: {} })
                .then(stream => { video.srcObject = stream; })
                .catch(err => console.error("Camera Error:", err));
        }

        // --- 4. Main Process Loop ---
        video.addEventListener('play', async () => {
            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏ô‡∏à‡∏≤‡∏Å Firebase ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°
            await loadLabeledImagesFromDB();
            
            isModelLoaded = true;
            statusText.innerText = "‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô";
            statusText.className = "badge bg-success status-badge";
            document.getElementById('btn-register').disabled = false;

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Canvas ‡∏ó‡∏±‡∏ö‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠
            canvas = faceapi.createCanvasFromMedia(video);
            wrapper.append(canvas);
            const displaySize = { width: video.width || 640, height: video.height || 480 };
            faceapi.matchDimensions(canvas, displaySize);

            // Loop ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ó‡∏∏‡∏Å 100ms
            setInterval(async () => {
                if(!isModelLoaded) return;

                const detections = await faceapi.detectAllFaces(video).withFaceLandmarks().withFaceDescriptors();
                const resizedDetections = faceapi.resizeResults(detections, displaySize);
                
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);

                if (labeledFaceDescriptors.length > 0) {
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Matcher ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ñ‡∏ô‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà
                    faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.6);
                    
                    const results = resizedDetections.map(d => faceMatcher.findBestMatch(d.descriptor));

                    results.forEach((result, i) => {
                        const box = resizedDetections[i].detection.box;
                        const { label, distance } = result;
                        
                        // ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≠‡∏ö
                        const drawBox = new faceapi.draw.DrawBox(box, { label: label + ` (${Math.round((1-distance)*100)}%)` });
                        drawBox.draw(canvas);

                        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡πÄ‡∏Å‡∏¥‡∏ô 50% ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà unknown)
                        if (label !== 'unknown' && distance < 0.5) {
                            recordAttendance(label);
                        }
                    });
                } else {
                    // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡∏¢
                    faceapi.draw.drawDetections(canvas, resizedDetections);
                }
            }, 100);
        });

        // --- 5. Firebase Functions ---

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å Firebase
        async function loadLabeledImagesFromDB() {
            const querySnapshot = await getDocs(collection(db, "faces"));
            labeledFaceDescriptors = [];
            
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                // ‡πÅ‡∏õ‡∏•‡∏á Array ‡∏õ‡∏Å‡∏ï‡∏¥ ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô Float32Array ‡∏ó‡∏µ‡πà AI ‡πÉ‡∏ä‡πâ
                const descriptor = new Float32Array(data.descriptor);
                labeledFaceDescriptors.push(new faceapi.LabeledFaceDescriptors(data.name, [descriptor]));
            });
            console.log("Loaded faces:", labeledFaceDescriptors.length);
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏î‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (Register)
        window.registerFace = async () => {
            const name = document.getElementById('employee-name').value.trim();
            if (!name) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', 'warning');

            statusText.innerText = "üì∏ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤...";
            
            // ‡∏à‡∏±‡∏ö‡∏†‡∏≤‡∏û‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
            const detection = await faceapi.detectSingleFace(video).withFaceLandmarks().withFaceDescriptor();
            
            if (detection) {
                // ‡πÅ‡∏õ‡∏•‡∏á Float32Array ‡πÄ‡∏õ‡πá‡∏ô Array ‡∏õ‡∏Å‡∏ï‡∏¥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏•‡∏á Firebase
                const descriptorArray = Array.from(detection.descriptor);
                
                try {
                    await addDoc(collection(db, "faces"), {
                        name: name,
                        descriptor: descriptorArray,
                        createdAt: serverTimestamp()
                    });
                    
                    Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏∏‡∏ì ${name} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!`, 'success');
                    document.getElementById('employee-name').value = '';
                    await loadLabeledImagesFromDB(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥
                    
                } catch (e) {
                    console.error(e);
                    Swal.fire('Error', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô', 'error');
                }
            } else {
                Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ç‡∏¢‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏≠‡∏î‡πÅ‡∏ß‡πà‡∏ô/‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å', 'error');
            }
            statusText.innerText = "‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô";
        };

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤ (Check-in)
        async function recordAttendance(name) {
            const now = new Date();
            // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏¥‡∏á‡∏ã‡πâ‡∏≥‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 1 ‡∏ô‡∏≤‡∏ó‡∏µ
            if (lastCheckInTime[name] && (now - lastCheckInTime[name]) < 60000) {
                return;
            }
            
            lastCheckInTime[name] = now;
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
            const logContainer = document.getElementById('log-container');
            const timeStr = now.toLocaleTimeString('th-TH');
            const html = `
                <div class="alert alert-success py-2 mb-2 fade show">
                    <strong>${name}</strong> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ ${timeStr}
                </div>`;
            logContainer.insertAdjacentHTML('afterbegin', html);

            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firebase
            try {
                await addDoc(collection(db, "attendance_logs"), {
                    name: name,
                    timestamp: serverTimestamp(),
                    type: 'check-in'
                });
            } catch (e) { console.error("Log error", e); }
        }

    </script>
</body>
</html>
