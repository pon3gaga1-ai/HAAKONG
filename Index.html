<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Money Link - รวมบัญชีรับเงิน</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --primary: #2563eb;
            --secondary: #3b82f6;
            --bg-gradient: linear-gradient(135deg, #f0f9ff 0%, #cbebff 100%);
        }

        body {
            font-family: 'Prompt', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: #334155;
        }

        /* Card Styles */
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            border: 1px solid rgba(255,255,255,0.8);
            overflow: hidden;
        }

        .auth-box { max-width: 400px; margin: 5vh auto; padding: 30px; }
        .main-box { max-width: 800px; margin: 20px auto; padding: 20px; }

        /* Secret Code Badge */
        .secret-code-display {
            background: linear-gradient(45deg, #2563eb, #4f46e5);
            color: white;
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(37, 99, 235, 0.3);
        }
        .code-text { font-size: 2.5rem; font-weight: 800; letter-spacing: 5px; font-family: monospace; }

        /* Bank Card Item */
        .bank-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
            transition: transform 0.2s;
            border-left: 6px solid #ccc;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
        }
        .bank-card:active { transform: scale(0.98); }
        
        /* Bank Colors (Border) */
        .bank-kbank { border-left-color: #138f2d; } /* กสิกร */
        .bank-scb { border-left-color: #4e2e7f; } /* ไทยพาณิชย์ */
        .bank-ktb { border-left-color: #00a5e5; } /* กรุงไทย */
        .bank-bbl { border-left-color: #1e4598; } /* กรุงเทพ */
        .bank-promptpay { border-left-color: #003d68; } /* พร้อมเพย์ */

        .copy-btn {
            background: #f1f5f9; color: #475569;
            border: none; padding: 8px 15px; border-radius: 50px;
            font-size: 0.8rem; font-weight: 600;
            transition: all 0.2s;
        }
        .copy-btn:hover { background: #e2e8f0; color: var(--primary); }

        /* Tabs */
        .nav-pills .nav-link {
            border-radius: 50px; color: #64748b; padding: 10px 20px;
        }
        .nav-pills .nav-link.active {
            background-color: var(--primary); color: white;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-light bg-transparent py-3">
        <div class="container d-flex justify-content-between">
            <a class="navbar-brand fw-bold text-primary" href="#"><i class="fas fa-wallet"></i> MoneyLink</a>
            <button onclick="logout()" id="logout-btn" class="btn btn-sm btn-outline-danger rounded-pill d-none">Logout</button>
        </div>
    </nav>

    <div id="auth-section" class="container">
        <div class="glass-card auth-box text-center">
            <h3 class="fw-bold mb-4">เข้าสู่ระบบ</h3>
            <div class="form-floating mb-3">
                <input type="email" class="form-control" id="email" placeholder="Email">
                <label>อีเมล</label>
            </div>
            <div class="form-floating mb-4">
                <input type="password" class="form-control" id="password" placeholder="Password">
                <label>รหัสผ่าน</label>
            </div>
            <button onclick="authAction()" class="btn btn-primary w-100 py-3 rounded-pill fw-bold shadow-sm">Login / Register</button>
            <p class="mt-3 text-muted small">กดปุ่มเพื่อเข้าสู่ระบบ หรือสมัครใหม่ทันที</p>
        </div>
    </div>

    <div id="app-section" class="container d-none">
        <div class="main-box">
            
            <ul class="nav nav-pills nav-fill mb-4 p-1 bg-white rounded-pill shadow-sm" style="max-width: 400px; margin: 0 auto;">
                <li class="nav-item">
                    <button class="nav-link active" onclick="switchTab('search')"><i class="fas fa-search me-1"></i> ค้นหา</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" onclick="switchTab('manage')"><i class="fas fa-user-cog me-1"></i> บัญชีของฉัน</button>
                </li>
            </ul>

            <div id="tab-search">
                <div class="text-center mb-5">
                    <h2 class="fw-bold text-dark">โอนเงินให้ใครดี?</h2>
                    <p class="text-muted">กรอกรหัสลับ 6 หลักของเพื่อน เพื่อดูเลขบัญชี</p>
                    
                    <div class="input-group shadow rounded-pill overflow-hidden bg-white mt-4" style="max-width: 500px; margin: 0 auto;">
                        <input type="text" id="search-code" class="form-control border-0 py-3 ps-4 fs-5" placeholder="ใส่รหัสลับ (เช่น X9A2B1)" style="letter-spacing: 2px; text-transform: uppercase;">
                        <button class="btn btn-primary px-4 fw-bold" onclick="searchProfile()">ค้นหา <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>

                <div id="search-result" class="d-none">
                    <h5 class="fw-bold border-start border-4 border-primary ps-3 mb-3">บัญชีของ: <span id="result-owner-name" class="text-primary">...</span></h5>
                    <div id="result-list">
                        </div>
                </div>
            </div>

            <div id="tab-manage" class="d-none">
                <div class="glass-card p-4 mb-4">
                    <div class="text-center">
                        <small class="text-uppercase text-muted fw-bold">รหัสลับของคุณ (ส่งให้คนโอน)</small>
                        <div class="secret-code-display mt-2">
                            <span id="my-secret-code" class="code-text">LOADING</span>
                        </div>
                        <button class="btn btn-sm btn-light rounded-pill text-primary" onclick="copyCode()"><i class="far fa-copy"></i> คัดลอกรหัส</button>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold m-0">รายการบัญชีของคุณ</h5>
                    <button class="btn btn-primary btn-sm rounded-pill" onclick="openAddModal()"><i class="fas fa-plus"></i> เพิ่มบัญชี</button>
                </div>

                <div id="my-account-list">
                    <p class="text-center text-muted py-4">ยังไม่มีบัญชี กดปุ่ม + เพื่อเพิ่มเลย</p>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, deleteDoc, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Config เดิมของคุณ
        const firebaseConfig = {
            apiKey: "AIzaSyDT39HkTA1TLFKvuQNZcrNeIZMLANgy2z0",
            authDomain: "scan-4b703.firebaseapp.com",
            projectId: "scan-4b703",
            storageBucket: "scan-4b703.firebasestorage.app",
            messagingSenderId: "667992011250",
            appId: "1:667992011250:web:adce534c0f97b4ddb47b6b",
            measurementId: "G-X5QG9YZWG6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;

        // --- Auth System ---
        window.authAction = async () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            if(!e || !p) return Swal.fire('แจ้งเตือน','กรุณากรอกข้อมูลให้ครบ','warning');

            try {
                // ลอง Login ก่อน
                await signInWithEmailAndPassword(auth, e, p);
            } catch (err) {
                // ถ้า Login ไม่ได้ ให้ลองสมัคร (Register)
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, e, p);
                    // สร้างรหัสลับ (Secret Code) 6 หลัก
                    const secretCode = generateSecretCode();
                    // บันทึก User Profile ลง Firestore
                    await setDoc(doc(db, "users", userCredential.user.uid), {
                        email: e,
                        secretCode: secretCode,
                        createdAt: new Date()
                    });
                    Swal.fire("สำเร็จ", `สมัครสมาชิกเรียบร้อย! รหัสลับของคุณคือ ${secretCode}`, "success");
                } catch (err2) {
                    Swal.fire("Error", err2.message, "error");
                }
            }
        };

        function generateSecretCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // ตัดตัว I,O,1,0 ออกกันงง
            let result = '';
            for (let i = 0; i < 6; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
            return result;
        }

        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                document.getElementById('auth-section').classList.add('d-none');
                document.getElementById('app-section').classList.remove('d-none');
                document.getElementById('logout-btn').classList.remove('d-none');
                
                // โหลดรหัสลับของตัวเอง
                loadMyProfile();
                // โหลดบัญชีธนาคารของตัวเอง
                loadMyAccounts();
                // เด้งไปหน้า Manage อัตโนมัติ
                switchTab('manage');
            } else {
                document.getElementById('auth-section').classList.remove('d-none');
                document.getElementById('app-section').classList.add('d-none');
                document.getElementById('logout-btn').classList.add('d-none');
            }
        });

        // --- Data Loading ---
        async function loadMyProfile() {
            const userDoc = await getDocs(query(collection(db, "users"), where("email", "==", currentUser.email)));
            if(!userDoc.empty) {
                const data = userDoc.docs[0].data();
                document.getElementById('my-secret-code').innerText = data.secretCode;
            }
        }

        function loadMyAccounts() {
            const q = query(collection(db, "bank_accounts"), where("userId", "==", currentUser.uid));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('my-account-list');
                list.innerHTML = '';
                if(snapshot.empty) {
                    list.innerHTML = '<p class="text-center text-muted mt-3">ยังไม่มีบัญชี</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const d = doc.data();
                    list.innerHTML += createBankCardHTML(d, true, doc.id); // true = เป็นเจ้าของ (มีปุ่มลบ)
                });
            });
        }

        // --- Search System ---
        window.searchProfile = async () => {
            const code = document.getElementById('search-code').value.toUpperCase().trim();
            if(!code) return;

            // 1. หา UID จาก Secret Code
            const userQuery = query(collection(db, "users"), where("secretCode", "==", code));
            const userSnap = await getDocs(userQuery);

            if(userSnap.empty) {
                Swal.fire('ไม่พบผู้ใช้', 'รหัสลับไม่ถูกต้อง', 'error');
                return;
            }

            const targetUser = userSnap.docs[0].data();
            const targetUid = userSnap.docs[0].id;
            
            document.getElementById('result-owner-name').innerText = targetUser.email.split('@')[0]; // โชว์ชื่อหน้า email

            // 2. ดึงบัญชีธนาคารของ UID นั้น
            const bankQuery = query(collection(db, "bank_accounts"), where("userId", "==", targetUid));
            const bankSnap = await getDocs(bankQuery);

            const resultList = document.getElementById('result-list');
            resultList.innerHTML = '';
            
            if(bankSnap.empty) {
                resultList.innerHTML = '<p class="text-muted">ผู้ใช้นี้ยังไม่ได้เพิ่มบัญชี</p>';
            } else {
                bankSnap.forEach(doc => {
                    resultList.innerHTML += createBankCardHTML(doc.data(), false, null); // false = คนอื่นดู (ไม่มีปุ่มลบ)
                });
            }

            document.getElementById('search-result').classList.remove('d-none');
        };

        // --- HTML Generator ---
        function createBankCardHTML(data, isOwner, docId) {
            // Mapping ชื่อธนาคารกับ class สี (ง่ายๆ)
            let bankClass = 'bank-promptpay';
            if(data.bankName.includes('กสิกร')) bankClass = 'bank-kbank';
            else if(data.bankName.includes('ไทยพาณิชย์')) bankClass = 'bank-scb';
            else if(data.bankName.includes('กรุงไทย')) bankClass = 'bank-ktb';
            else if(data.bankName.includes('กรุงเทพ')) bankClass = 'bank-bbl';

            let btnAction = '';
            if(isOwner) {
                btnAction = `<button class="btn btn-sm text-danger ms-2" onclick="deleteAccount('${docId}')"><i class="fas fa-trash"></i></button>`;
            }

            return `
            <div class="bank-card ${bankClass}">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="text-muted small mb-1">${data.bankName}</div>
                        <h4 class="fw-bold m-0" style="letter-spacing:1px; font-family:monospace">${data.accountNumber}</h4>
                        <div class="text-dark mt-1">${data.accountName}</div>
                    </div>
                    <div class="d-flex align-items-center">
                        <button class="copy-btn shadow-sm" onclick="copyText('${data.accountNumber}')">
                            <i class="far fa-copy"></i> คัดลอก
                        </button>
                        ${btnAction}
                    </div>
                </div>
            </div>`;
        }

        // --- Actions ---
        window.openAddModal = async () => {
            const { value: formValues } = await Swal.fire({
                title: 'เพิ่มบัญชีใหม่',
                html: `
                    <select id="swal-bank" class="swal2-select w-75 mb-3">
                        <option value="กสิกรไทย">กสิกรไทย (KBANK)</option>
                        <option value="ไทยพาณิชย์">ไทยพาณิชย์ (SCB)</option>
                        <option value="กรุงไทย">กรุงไทย (KTB)</option>
                        <option value="กรุงเทพ">กรุงเทพ (BBL)</option>
                        <option value="พร้อมเพย์">พร้อมเพย์ (PromptPay)</option>
                        <option value="TrueMoney">TrueMoney Wallet</option>
                    </select>
                    <input id="swal-acc-num" class="swal2-input" placeholder="เลขบัญชี / เบอร์โทร">
                    <input id="swal-acc-name" class="swal2-input" placeholder="ชื่อบัญชี (ภาษาไทย/อังกฤษ)">
                `,
                focusConfirm: false,
                showCancelButton: true,
                preConfirm: () => {
                    return [
                        document.getElementById('swal-bank').value,
                        document.getElementById('swal-acc-num').value,
                        document.getElementById('swal-acc-name').value
                    ]
                }
            });

            if (formValues && formValues[1]) {
                await addDoc(collection(db, "bank_accounts"), {
                    userId: currentUser.uid,
                    bankName: formValues[0],
                    accountNumber: formValues[1],
                    accountName: formValues[2],
                    createdAt: new Date()
                });
                Swal.fire('บันทึกสำเร็จ', '', 'success');
            }
        };

        window.deleteAccount = async (id) => {
            const res = await Swal.fire({ title: 'ลบบัญชีนี้?', icon: 'warning', showCancelButton: true });
            if(res.isConfirmed) await deleteDoc(doc(db, "bank_accounts", id));
        };

        window.copyText = (text) => {
            navigator.clipboard.writeText(text);
            const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1000 });
            Toast.fire({ icon: 'success', title: 'คัดลอกเลขบัญชีแล้ว' });
        };
        
        window.copyCode = () => {
            const code = document.getElementById('my-secret-code').innerText;
            window.copyText(code);
        }

        // UI Tabs
        window.switchTab = (tabName) => {
            document.getElementById('tab-search').classList.add('d-none');
            document.getElementById('tab-manage').classList.add('d-none');
            document.getElementById('tab-' + tabName).classList.remove('d-none');
            
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active'); // บรรทัดนี้อาจ error ถ้าเรียกจาก code โดยไม่มี event แต่ไม่เป็นไร
            // Hack fix for tab active state when called from code
            if(tabName === 'manage') document.querySelector('.nav-link:nth-child(2)').classList.add('active');
        };
    </script>
</body>
</html>
